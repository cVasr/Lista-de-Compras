<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Calculadora de Compras</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Ionicons Library -->
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        ion-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        html {
            height: 100%;
            overflow: hidden;
        }
        
        :root {
            --primary-color: #39ff14;
            --primary-text: #39ff14;
            --bg-dark: #0f0f0f;
            --bg-card: #1a1a1a;
            --bg-input: #0f0f0f;
            --border-color: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #e0e0e0;
            --text-muted: #808080;
            --bottom-fixed-height: 0px;
        }
        
        [data-theme="light"] {
            --primary-text: #1a1a1a;
            --bg-dark: #f5f5f5;
            --bg-card: #ffffff;
            --bg-input: #f0f0f0;
            --border-color: #e0e0e0;
            --text-primary: #1a1a1a;
            --text-secondary: #2a2a2a;
            --text-muted: #666666;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-card) 50%, var(--bg-dark) 100%);
            color: var(--text-primary);
            height: 100%;
            overflow: hidden;
            transition: background 0.3s ease, color 0.3s ease;
        }
        
        body.no-scroll {
            overflow: hidden;
            position: fixed;
            width: 100%;
        }
        
        /* Header */
        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 16px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            transition: background 0.3s ease, border-color 0.3s ease;
        }
        
        .menu-btn {
            width: 40px;
            height: 40px;
            background: transparent;
            border: none;
            color: var(--primary-text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: background 0.3s;
        }
        
        .menu-btn svg {
            width: 24px;
            height: 24px;
            fill: var(--primary-text);
        }
        
        .menu-btn ion-icon {
            width: 24px;
            height: 24px;
            color: var(--primary-text);
            font-size: 24px;
        }
        
        .menu-btn:active {
            background: rgba(57, 255, 20, 0.1);
        }
        
        .app-title {
            flex: 1;
            text-align: center;
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-text);
        }
        
        /* Theme Toggle Switch Styles */
        .theme-toggle-container {
            cursor: pointer;
            user-select: none;
        }
        
        .theme-toggle-track {
            position: relative;
            width: 60px;
            height: 32px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            transition: all 0.3s ease;
        }
        
        .theme-toggle-thumb {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: var(--primary-color);
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .theme-toggle-icons {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 8px;
            pointer-events: none;
        }
        
        .theme-icon {
            width: 16px;
            height: 16px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        
        .theme-icon-sun {
            fill: var(--primary-color);
            opacity: 0.3;
            color: var(--primary-color);
        }
        
        .theme-icon-moon {
            fill: var(--text-secondary);
            opacity: 1;
            color: var(--text-secondary);
        }
        
        /* Light theme state */
        [data-theme="light"] .theme-toggle-thumb {
            transform: translateX(28px);
        }
        
        [data-theme="light"] .theme-icon-sun {
            opacity: 1;
            fill: var(--primary-color);
        }
        
        [data-theme="light"] .theme-icon-moon {
            opacity: 0.3;
        }
        
        .header-spacer {
            width: 40px;
        }
        
        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100vh;
            background: var(--bg-card);
            border-right: 1px solid var(--border-color);
            transition: left 0.3s ease, background 0.3s ease, border-color 0.3s ease;
            z-index: 1100;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar.active {
            left: 0;
        }
        
        .sidebar-header {
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .sidebar-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .close-sidebar {
            width: 36px;
            height: 36px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-sidebar svg {
            width: 20px;
            height: 20px;
            stroke: var(--text-muted);
        }
        
        .close-sidebar:active {
            background: rgba(255,255,255,0.1);
        }
        
        .sidebar-menu {
            padding: 16px 0;
            flex: 1;
        }
        
        .menu-item {
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }
        
        .menu-item:active {
            background: rgba(57, 255, 20, 0.1);
        }
        
        .menu-item.active {
            background: rgba(57, 255, 20, 0.1);
            color: var(--primary-text);
            border-left-color: var(--primary-text);
        }
        
        .menu-item-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .menu-item-icon svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }
        
        .menu-item-text {
            font-size: 15px;
            font-weight: 600;
            color: var(--primary-text);
        }
        
        [data-theme="light"] .menu-item-text {
            color: #1a1a1a;
        }
        
        /* Overlay */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            z-index: 1050;
        }
        
        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        /* Bloquear sidebar cuando hay modal confirmaci√≥n */
        .sidebar-overlay.blocked {
            pointer-events: none !important;
        }
        
        /* Main Content - Contenedor padre */
        .main-content {
            position: relative;
            margin-top: 60px;
            width: 100%;
            height: calc(100vh - 60px);
            overflow: hidden !important;
        }
        
        /* ============================================================
           ARQUITECTURA DE NAVEGACI√ìN - SECCIONES DE CONTENIDO
           ============================================================
           PATR√ìN √öNICO: Todas las secciones usan el mismo sistema
           - display: none (oculto por defecto)
           - display: flex SOLO cuando tiene clase .active
           - NUNCA agregar display: flex directamente a #seccionXXX
           ============================================================ */
        
        .content-section {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: none;           /* OCULTO POR DEFECTO */
            flex-direction: column;
            z-index: 10;
        }
        
        .content-section.active {
            display: flex;           /* VISIBLE SOLO CUANDO EST√Å ACTIVO */
            overflow: hidden;
            z-index: 100;
        }
        
        /* ============================================================
           ESTILOS ESPEC√çFICOS (No rompen el patr√≥n de visibilidad)
           ============================================================ */
        
        /* Secci√≥n INICIO - Gestiona su propio espacio de forma independiente */
        #seccionInicio {
            padding: 0;
            gap: 0;
            display: none;
        }
        
        #seccionInicio.active {
            display: flex;
        }
        
        /* Otras secciones - Cada una independiente con scroll */
        #seccionListas,
        #seccionGraficos,
        #seccionConfiguracion {
            padding: 16px;
            scrollbar-gutter: stable;
            display: none;
            overflow-y: scroll !important;
            overflow-x: hidden !important;
        }
        
        /* Cuando est√°n activas */
        #seccionListas.active,
        #seccionGraficos.active,
        #seccionConfiguracion.active {
            display: flex;
            padding-bottom: 100px;
        }
        
        /* Ocultar scrollbars en todas las secciones */
        #seccionInicio::-webkit-scrollbar,
        #seccionListas::-webkit-scrollbar,
        #seccionGraficos::-webkit-scrollbar,
        #seccionConfiguracion::-webkit-scrollbar {
            width: 0;
            height: 0;
        }
        
        #seccionInicio,
        #seccionListas,
        #seccionGraficos,
        #seccionConfiguracion {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* Botones de acci√≥n - Header (NO scrollea NUNCA) */
        .action-buttons-top {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            padding: 16px;
            flex-shrink: 0;
            width: 100%;
        }
        
        /* Contenedor de scroll - El √öNICO que scrollea */
        .items-scroll-container {
            overflow-y: auto !important;
            overflow-x: hidden !important;
            background: transparent;
            border: none;
            border-radius: 12px;
            -webkit-overflow-scrolling: touch;
            flex: 1;
            min-height: 0;
            scrollbar-gutter: stable;
            padding: 0 16px;
            padding-bottom: 320px;
        }
        
        /* Ocultar scrollbar */
        .items-scroll-container::-webkit-scrollbar {
            width: 0;
            height: 0;
        }
        
        .items-scroll-container {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .bottom-fixed-container {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-dark);
            border-top: 1px solid var(--border-color);
            padding: 16px;
            padding-bottom: max(16px, env(safe-area-inset-bottom));
            transition: background 0.3s ease, border-color 0.3s ease;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
            z-index: 900;
            box-sizing: border-box;
            flex-direction: column;
            gap: 10px;
        }
        
        /* Mostrar cuando seccionInicio est√° activo */
        .bottom-fixed-container.visible {
            display: flex;
        }
        
        .btn-add-item {
            width: 100%;
            padding: 10px;
            font-size: 14px;
            margin-bottom: 0;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        /* Lista de Compras */
        .items-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        /* Category Group */
        .category-group {
            margin-bottom: 8px;
        }
        
        .category-header {
            font-size: 13px;
            font-weight: 700;
            color: var(--text-muted);
            padding: 8px 12px;
            background: var(--bg-input);
            border-radius: 8px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .item-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 12px;
            transition: background 0.3s ease, border-color 0.3s ease, opacity 0.2s ease;
            position: relative;
            cursor: grab;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .item-card:active {
            cursor: grabbing;
        }
        
        .item-card.dragging {
            opacity: 1 !important;
            cursor: grabbing;
            z-index: 10;
        }
        
        /* Item comprado */
        .item-comprado {
            opacity: 0.5;
        }
        
        .item-comprado .item-name,
        .item-comprado .item-price {
            text-decoration: line-through;
        }
        
        /* Fila 1: Nombre, Precio y Checkbox */
        .item-row-1 {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }
        
        .item-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .item-right-1 {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }
        
        .item-price {
            font-size: 15px;
            font-weight: 700;
            color: var(--primary-text);
            white-space: nowrap;
        }
        
        .checkbox-compra {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--primary-color);
            flex-shrink: 0;
        }
        
        /* Fila 2: Unidades, Marca, Categor√≠a */
        .item-row-2 {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
        }
        
        .item-detail {
            font-size: 12px;
            color: var(--text-secondary);
            padding: 3px 8px;
            background: var(--bg-input);
            border-radius: 6px;
            white-space: nowrap;
        }
        
        /* Fila 3: Promoci√≥n y Nota */
        .item-row-3 {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .item-promo,
        .item-nota {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            padding: 6px 10px;
            border-radius: 8px;
        }
        
        .item-promo {
            background: rgba(57, 255, 20, 0.1);
            border: 1px solid var(--primary-color);
            color: var(--primary-text);
        }
        
        .item-promo svg {
            width: 16px;
            height: 16px;
            fill: var(--primary-color);
            flex-shrink: 0;
        }
        
        .item-nota {
            background: rgba(255, 204, 0, 0.1);
            border: 1px solid #ffcc00;
            color: #ffcc00;
            font-style: italic;
        }
        
        .item-nota svg {
            width: 16px;
            height: 16px;
            fill: #ffcc00;
            flex-shrink: 0;
        }
        
        /* Fila 4: Botones de acci√≥n */
        .item-row-4 {
            display: flex;
            justify-content: flex-end;
            gap: 6px;
            padding-top: 4px;
            border-top: 1px solid var(--border-color);
        }
        
        .item-btn-icon {
            width: 36px;
            height: 36px;
            border: 1px solid var(--border-color);
            background: var(--bg-input);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        
        .item-btn-icon:hover {
            background: var(--bg-input);
            border-color: var(--border-color);
        }
        
        .item-btn-icon:disabled {
            cursor: not-allowed;
            opacity: 1;
            background: var(--bg-input);
            border-color: var(--border-color);
        }
        
        .item-btn-icon:disabled:hover {
            background: var(--bg-input);
            border-color: var(--border-color);
        }
        
        .item-btn-icon:disabled svg {
            stroke: var(--text-primary);
            fill: var(--text-primary);
        }
        
        .item-btn-icon:disabled:hover svg {
            stroke: var(--text-primary);
            fill: var(--text-primary);
        }
        
        .item-btn-icon ion-icon {
            width: 18px;
            height: 18px;
            color: var(--text-primary);
            font-size: 18px;
        }
        
        .item-btn-icon svg {
            width: 18px;
            height: 18px;
            stroke: var(--text-primary);
            fill: none;
            transition: all 0.2s;
        }
        
        .item-btn-icon:hover svg {
            stroke: var(--text-primary);
            fill: none;
        }
        
        .item-btn-drag svg {
            fill: var(--text-primary);
            stroke: none;
        }
        
        .item-btn-icon:hover .item-btn-drag svg,
        .item-btn-drag:hover svg {
            fill: var(--text-primary);
        }
        
        /* Responsive - Mobile */
        @media (max-width: 480px) {
            .item-row-3 {
                flex-direction: column;
            }
        }
        
        /* Summary Card */
        .summary-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
        }
        
        .summary-row.total {
            border-top: 2px solid var(--primary-color);
            margin-top: 8px;
            padding-top: 12px;
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        /* Budget Card */
        .budget-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 0;
            transition: background 0.3s ease, border-color 0.3s ease;
        }
        
        #budgetCardEmpty,
        #budgetCardFull {
            width: 100%;
            display: flex;
            flex-direction: column;
        }
        
        #budgetCardEmpty > div {
            text-align: center;
            padding: 8px 0;
        }
        
        .budget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0;
        }
        
        .budget-label {
            font-size: 10px;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .budget-edit-btn {
            width: 32px;
            height: 32px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .budget-edit-btn svg {
            width: 16px;
            height: 16px;
            stroke: var(--text-primary);
            fill: none;
            transition: stroke 0.3s;
        }
        
        .budget-edit-btn ion-icon {
            width: 16px;
            height: 16px;
            color: var(--text-primary);
            transition: color 0.3s;
        }
        
        .budget-edit-btn:active {
            background: rgba(57, 255, 20, 0.1);
            border-color: var(--primary-color);
        }
        
        .budget-edit-btn:active svg {
            stroke: var(--primary-color);
        }
        
        .budget-edit-btn:active ion-icon {
            color: var(--primary-color);
        }
        
        /* Contenedor de botones de presupuesto */
        .budget-buttons-group {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        
        /* Bot√≥n de borrar presupuesto */
        .budget-delete-btn {
            width: 32px;
            height: 32px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .budget-delete-btn svg {
            width: 16px;
            height: 16px;
            stroke: var(--text-primary);
            fill: none;
            transition: stroke 0.3s;
        }
        
        .budget-delete-btn ion-icon {
            width: 16px;
            height: 16px;
            color: var(--text-primary);
            transition: color 0.3s;
        }
        
        .budget-delete-btn:active {
            background: rgba(255, 50, 50, 0.1);
            border-color: #ff3232;
        }
        
        .budget-delete-btn:active svg {
            stroke: #ff3232;
        }
        
        .budget-delete-btn:active ion-icon {
            color: #ff3232;
        }
        
        .budget-amount {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary-text);
            margin: 2px 0 0 0;
        }
        
        [data-theme="light"] .budget-amount {
            color: #39ff14;
        }
        
        .budget-remaining {
            font-size: 11px;
            color: var(--text-secondary);
            margin: 2px 0 0 0;
        }
        
        .budget-remaining.warning {
            color: #ff9500;
        }
        
        .budget-remaining.danger {
            color: #ff3232;
        }
        
        /* Barra de progreso */
        .budget-progress-bar {
            width: 100%;
            height: 6px;
            background: var(--bg-input);
            border-radius: 10px;
            overflow: hidden;
            margin: 2px 0 0 0;
        }
        
        [data-theme="light"] .budget-progress-bar {
            background: #e0e0e0 !important;
        }
        
        [data-theme="light"] .budget-progress-fill.low {
            background: #39ff14 !important;
        }
        
        [data-theme="light"] .budget-progress-fill.medium {
            background: #ff9500 !important;
        }
        
        [data-theme="light"] .budget-progress-fill.high {
            background: #ff3232 !important;
        }
        
        .budget-progress-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease, background 0.3s ease;
        }
        
        .budget-progress-fill.low {
            background: #39ff14;
        }
        
        .budget-progress-fill.medium {
            background: #ff9500;
        }
        
        .budget-progress-fill.high {
            background: #ff3232;
        }
        
        /* Summary Grid */
        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1px;
            background: var(--border-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            transition: background 0.3s ease, border-color 0.3s ease;
        }
        
        .summary-col {
            background: var(--bg-card);
            padding: 10px 8px;
            text-align: center;
            transition: background 0.3s ease;
        }
        
        .summary-col-label {
            font-size: 10px;
            color: var(--text-muted);
            margin-bottom: 6px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .summary-col-value {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .summary-col-total {
            background: rgba(57, 255, 20, 0.05);
        }
        
        .summary-col-total .summary-col-label {
            color: var(--primary-text);
        }
        
        .summary-col-total .summary-col-value {
            color: var(--primary-text);
            font-size: 16px;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .btn {
            flex: 1;
            padding: 10px 12px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            min-height: 40px;
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: #000;
        }
        
        .btn-primary:active {
            background: #2ecc40;
            transform: scale(0.98);
        }
        
        .btn-secondary {
            background: var(--bg-input);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            transition: all 0.2s ease, background 0.3s ease, border-color 0.3s ease;
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
        }
        
        .btn-secondary:active {
            background: var(--border-color);
            transform: scale(0.98);
        }
        
        .action-buttons-top .btn {
            flex: 1;
            min-width: auto;
        }
        
        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
            pointer-events: auto;
        }
        
        /* Bloquear interacciones fuera del modal */
        .modal.active ~ * {
            pointer-events: none !important;
        }
        
        body.no-scroll .modal:not(.active) {
            pointer-events: none;
        }
        
        .modal-content {
            background: var(--bg-card);
            border-radius: 24px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            animation: fadeIn 0.3s ease;
        }
        

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--bg-card);
            z-index: 1;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .modal-close {
            width: 32px;
            height: 32px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-close svg {
            width: 20px;
            height: 20px;
            stroke: var(--text-muted);
        }
        
        .modal-close:active {
            background: rgba(255,255,255,0.1);
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-label {
            display: block;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            background: var(--bg-input);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(57, 255, 20, 0.1);
        }
        
        .form-input::placeholder {
            color: var(--text-muted);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: var(--bg-input);
            border-radius: 10px;
            cursor: pointer;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .checkbox-group label {
            flex: 1;
            cursor: pointer;
            font-size: 14px;
        }
        
        .promo-options {
            display: none;
            margin-top: 12px;
        }
        
        .promo-options.active {
            display: block;
        }
        
        .radio-group {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .radio-option {
            flex: 1;
            padding: 12px;
            background: var(--bg-input);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .radio-option.selected {
            border-color: var(--primary-color);
            background: rgba(57, 255, 20, 0.1);
            color: var(--primary-color);
        }
        
        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 12px;
            position: sticky;
            bottom: 0;
            background: var(--bg-card);
        }
        
        /* Configuraci√≥n */
        .config-section {
            margin-bottom: 24px;
        }
        
        .config-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--primary-text);
            margin-bottom: 8px;
        }
        
        .config-description {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 12px;
        }
        
        .config-option {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            transition: background 0.3s ease, border-color 0.3s ease;
        }
        
        .config-checkbox {
            padding: 12px 16px;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            user-select: none;
        }
        
        .checkbox-label input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--primary-color);
        }
        
        .checkbox-label span {
            font-size: 15px;
            color: var(--text-primary);
            font-weight: 500;
        }
        
        .config-label {
            display: block;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        /* Bot√≥n aplicar cambios en configuraci√≥n */
        .btn-aplicar-container {
            position: sticky;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px;
            background: var(--bg-dark);
            border-top: 1px solid var(--border-color);
            display: none;
            z-index: 100;
        }
        
        .btn-aplicar-container .action-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 0;
        }
        
        .btn-aplicar-container .btn {
            flex: 1;
        }
        
        .color-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 12px;
        }
        
        .color-option {
            aspect-ratio: 1;
            border-radius: 12px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .color-option.selected {
            border-color: var(--text-primary);
        }
        
        /* Lista Guardadas */
        .saved-list-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .saved-list-card:active {
            transform: scale(0.98);
        }
        
        .saved-list-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .saved-list-name {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .saved-list-date {
            font-size: 12px;
            color: var(--text-muted);
        }
        
        .iva-indicator {
            font-size: 11px;
            color: #39ff14;
            margin-top: 4px;
            font-weight: 500;
        }
        
        [data-theme="light"] .iva-indicator {
            color: #c41e3a;
        }
        
        .saved-list-info {
            display: flex;
            gap: 12px;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }
        
        .saved-list-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .saved-list-actions .btn {
            flex: 1;
            min-width: 140px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }
        
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .empty-state-text {
            font-size: 16px;
            margin-bottom: 12px;
        }
        
        .empty-state-link {
            margin-top: 12px;
        }
        
        .empty-state-link a {
            color: var(--primary-text);
            text-decoration: underline;
            font-size: 14px;
            cursor: pointer;
        }
        
        .empty-state-link a:hover {
            opacity: 0.8;
        }
        
        /* Confirm Dialog Overlay */
        .confirm-dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 3000;
            display: none;
            pointer-events: auto;
        }
        
        .confirm-dialog-overlay.active {
            display: block;
        }
        
        /* Confirm Dialog */
        .confirm-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            padding: 24px;
            width: calc(100% - 32px);
            max-width: 400px;
            z-index: 3001;
            display: none;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .confirm-dialog.active {
            display: block;
        }
        
        .confirm-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 12px;
        }
        
        .confirm-text {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 20px;
            white-space: pre-line;
            line-height: 1.4;
        }
        
        .confirm-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .confirm-actions .btn {
            padding: 8px 12px;
            min-height: auto;
            font-size: 12px;
        }
        
        .confirm-close-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 28px;
            height: 28px;
            background: transparent;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            transition: all 0.2s ease;
            border-radius: 6px;
        }
        
        .confirm-close-btn:active {
            background: rgba(57, 255, 20, 0.1);
            color: var(--primary-color);
        }
        
        .confirm-close-btn ion-icon {
            width: 20px;
            height: 20px;
            font-size: 20px;
        }
        
        /* Modal Resumen */
        .modal-resumen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }
        
        .modal-resumen.active {
            display: flex;
        }
        
        .resumen-container {
            background: #ffffff;
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .resumen-header {
            padding: 24px;
            text-align: center;
            border-bottom: 2px solid #e0e0e0;
            background: #ffffff;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            position: relative;
        }
        
        .resumen-header-content {
            flex: 1;
            text-align: center;
        }
        
        .resumen-close-btn {
            background: transparent;
            border: none;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #666666;
            font-size: 24px;
            padding: 0;
            transition: color 0.3s;
        }
        
        .resumen-close-btn:hover {
            color: #000000;
        }
        
        .resumen-close-btn:active {
            transform: scale(0.95);
        }
        
        .resumen-title {
            font-size: 24px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 8px;
        }
        
        .resumen-date {
            font-size: 14px;
            color: #666666;
        }
        
        .resumen-items {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #ffffff;
        }
        
        .resumen-item {
            padding: 16px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .resumen-item:last-child {
            border-bottom: none;
        }
        
        .resumen-item-info {
            flex: 1;
        }
        
        .resumen-item-name {
            font-weight: 700;
            font-size: 16px;
            color: #1a1a1a;
            margin-bottom: 4px;
        }
        
        .resumen-item-details {
            font-size: 13px;
            color: #666666;
        }
        
        .resumen-item-price {
            font-weight: 700;
            font-size: 16px;
            color: #1a1a1a;
            white-space: nowrap;
            margin-left: 12px;
        }
        
        .resumen-summary {
            padding: 20px;
            background: #f5f5f5;
            border-top: 2px solid #e0e0e0;
        }
        
        .resumen-summary-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 15px;
            color: #1a1a1a;
        }
        
        .resumen-summary-row.budget {
            padding-top: 0;
            padding-bottom: 12px;
            border-bottom: 1px solid #d0d0d0;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .resumen-summary-row.total {
            border-top: 2px solid #1a1a1a;
            padding: 12px;
            margin-top: 8px;
            font-size: 20px;
            font-weight: 700;
            color: #39ff14;
            background: #0f0f0f;
            border-radius: 8px;
        }
        
        .resumen-actions {
            padding: 20px;
            display: flex;
            gap: 12px;
            background: #ffffff;
            border-top: 1px solid #e0e0e0;
        }
        
        .resumen-actions .btn {
            flex: 1;
        }
        
        /* Esconder FAB cuando no est√© en inicio */
        .chart-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
            min-height: 300px;
        }
        
        .chart-container canvas {
            max-height: 400px;
        }
        
        .chart-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 16px;
        }
        
        /* Tabs de Mis Gastos */
        .gastos-tabs {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            padding: 0 16px 16px 16px;
            margin: 0 -16px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .gastos-tabs::-webkit-scrollbar {
            display: none;
        }
        
        .gastos-tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 3px;
            padding: 6px 8px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--text-primary);
            font-size: 9px;
            font-weight: 600;
        }
        
        .gastos-tab:hover {
            background: var(--bg-input);
            border-color: var(--primary-color);
        }
        
        .gastos-tab.active {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: #000000;
        }
        
        .tab-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .tab-icon svg {
            width: 20px;
            height: 20px;
            color: var(--text-primary);
        }
        
        .tab-icon ion-icon {
            width: 20px;
            height: 20px;
            font-size: 20px;
            color: var(--text-primary);
        }
        
        .gastos-tab.active .tab-icon svg {
            color: #000000;
        }
        
        .gastos-tab.active .tab-icon ion-icon {
            color: #000000;
        }
        
        .tab-text {
            font-size: 11px;
            font-weight: 600;
            text-align: center;
        }
        
        /* Contenido de paneles */
        .gastos-content {
            position: relative;
            margin-top: 16px;
        }
        
        .gastos-panel {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .gastos-panel.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .panel-header {
            margin-bottom: 20px;
        }
        
        .panel-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary-text);
            margin-bottom: 4px;
        }
        
        .panel-subtitle {
            font-size: 13px;
            color: var(--text-muted);
        }
        
        /* Stat Cards */
        .descuentos-cards,
        .presupuesto-cards {
            display: grid;
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .stat-card-icon {
            width: 34px;
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(57, 255, 20, 0.1);
            border-radius: 12px;
            flex-shrink: 0;
        }
        
        .stat-card-icon svg {
            width: 20px;
            height: 20px;
            fill: var(--text-primary);
        }
        
        .stat-card-icon ion-icon {
            width: 20px;
            height: 20px;
            font-size: 20px;
            color: var(--text-primary);
        }
        
        .stat-card-content {
            flex: 1;
        }
        
        .stat-card-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }
        
        .stat-card-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-text);
        }
        
        [data-theme="light"] #diferencia {
            color: #000000 !important;
        }
        
        /* Panel Stats */
        .panel-stats {
            margin-top: 24px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }
        
        .stat-row-label {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .stat-row-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--primary-text);
        }
        
        /* An√°lisis de presupuesto */
        #presupuestoAnalisis {
            margin-top: 20px;
            padding: 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
        }
        
        .analisis-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .analisis-icon {
            font-size: 24px;
        }
        
        .analisis-text {
            flex: 1;
        }
        
        .analisis-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary-text);
            margin-bottom: 2px;
        }
        
        .analisis-description {
            font-size: 12px;
            color: var(--text-muted);
        }
        
        @media (min-width: 768px) {
            .main-content {
                max-width: 600px;
                margin-left: auto;
                margin-right: auto;
            }
            
            .modal-content {
                border-radius: 24px;
                max-height: 80vh;
            }
        }
        
        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            margin-top: auto;
        }
        
        .sidebar-footer-text {
            font-size: 13px;
            color: var(--text-muted);
            text-align: center;
        }
        
        .sidebar-footer-text a {
            color: var(--primary-text);
            text-decoration: none;
            transition: color 0.3s ease;
        }
        
        .sidebar-footer-text a:hover {
            color: var(--primary-color);
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="app-header">
        <button class="menu-btn" onclick="toggleSidebar()">
            <ion-icon name="menu"></ion-icon>
        </button>
        <div class="app-title">Lista de Compras</div>
        <div class="theme-toggle-container" onclick="toggleTheme()">
            <div class="theme-toggle-track">
                <div class="theme-toggle-icons">
                    <ion-icon class="theme-icon theme-icon-sun" name="sunny"></ion-icon>
                    <ion-icon class="theme-icon theme-icon-moon" name="moon"></ion-icon>
                </div>
                <div class="theme-toggle-thumb"></div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">Men√∫</div>
            <button class="close-sidebar" onclick="toggleSidebar()">
                <ion-icon name="close"></ion-icon>
            </button>
        </div>
        <div class="sidebar-menu">
            <div class="menu-item active" onclick="navigateTo('inicio')">
                <span class="menu-item-icon">
                    <ion-icon name="home"></ion-icon>
                </span>
                <span class="menu-item-text">Inicio</span>
            </div>
            <div class="menu-item" onclick="navigateTo('listas')">
                <span class="menu-item-icon">
                    <ion-icon name="document-text"></ion-icon>
                </span>
                <span class="menu-item-text">Listas guardadas</span>
            </div>
            <div class="menu-item" onclick="navigateTo('graficos')">
                <span class="menu-item-icon">
                    <ion-icon name="bar-chart"></ion-icon>
                </span>
                <span class="menu-item-text">Mis Gastos</span>
            </div>
            <div class="menu-item" onclick="navigateTo('configuracion')">
                <span class="menu-item-icon">
                    <ion-icon name="settings"></ion-icon>
                </span>
                <span class="menu-item-text">Configuraci√≥n</span>
            </div>
        </div>
        <div class="sidebar-footer">
            <div class="sidebar-footer-text">By: <a href="https://gabrielsebastianweb.com/" target="_blank" rel="noopener noreferrer">Gabriel Sebastian Web</a></div>
        </div>
    </div>

    <!-- Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Inicio - Contenedor √∫nico con header y scroll -->
        <div class="content-section active" id="seccionInicio">
            <!-- 1. Botones de acci√≥n (Header) -->
            <div class="action-buttons-top">
                <button class="btn btn-secondary" onclick="guardarLista()">
                    <ion-icon name="save" style="margin-right: 4px;"></ion-icon>
                    Guardar lista
                </button>
                <button class="btn btn-secondary" onclick="confirmarLimpiar()">
                    <ion-icon name="trash" style="margin-right: 4px;"></ion-icon>
                    Limpiar todo
                </button>
            </div>

            <!-- 2. Indicador de lista cargada -->
            <div id="indicadorListaCargada" style="display: none; padding: 10px; background: rgba(57, 255, 20, 0.1); border-left: 4px solid var(--primary-color); margin: 0px 16px 16px 16px; border-radius: 4px;">
                <div style="font-size: 14px; color: var(--text-primary);">
                    Lista cargada: <span style="font-weight: 500;" id="nombreListaCargadaDisplay"></span>
                </div>
            </div>

            <!-- 3. Lista de art√≠culos con scroll -->
            <div class="items-scroll-container">
                <div id="listaCompras" class="items-list"></div>

                <div class="empty-state" id="emptyState" style="display: none;">
                    <div class="empty-state-icon">
                        <svg style="width: 64px; height: 64px; opacity: 0.5;" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="9" cy="21" r="1" stroke="currentColor" stroke-width="2"/>
                            <circle cx="20" cy="21" r="1" stroke="currentColor" stroke-width="2"/>
                            <path d="M1 1H5L7.68 14.39C7.77144 14.8504 8.02191 15.264 8.38755 15.5583C8.75318 15.8526 9.2107 16.009 9.68 16H19.4C19.8693 16.009 20.3268 15.8526 20.6925 15.5583C21.0581 15.264 21.3086 14.8504 21.4 14.39L23 6H6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="empty-state-text">No hay art√≠culos en la lista</div>
                    <div class="empty-state-link">
                        <a href="#" onclick="navigateTo('configuracion'); return false;">Personaliza los campos del formulario</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Listas Guardadas -->
        <div class="content-section" id="seccionListas">
            <div id="listasGuardadas"></div>
        </div>

        <!-- Mis Gastos -->
        <div class="content-section" id="seccionGraficos">
            <!-- Tabs de indicadores -->
            <div class="gastos-tabs">
                <button class="gastos-tab active" onclick="cambiarTabGastos('top-articulos')" data-tab="top-articulos">
                    <span class="tab-icon">
                        <ion-icon name="star"></ion-icon>
                    </span>
                    <span class="tab-text">Top Art√≠culos</span>
                </button>
                <button class="gastos-tab" onclick="cambiarTabGastos('por-categoria')" data-tab="por-categoria">
                    <span class="tab-icon">
                        <ion-icon name="stats-chart"></ion-icon>
                    </span>
                    <span class="tab-text">Por Categor√≠a</span>
                </button>
                <button class="gastos-tab" onclick="cambiarTabGastos('descuentos')" data-tab="descuentos">
                    <span class="tab-icon">
                        <ion-icon name="pricetag"></ion-icon>
                    </span>
                    <span class="tab-text">Descuentos</span>
                </button>
                <button class="gastos-tab" onclick="cambiarTabGastos('comparacion')" data-tab="comparacion">
                    <span class="tab-icon">
                        <ion-icon name="podium"></ion-icon>
                    </span>
                    <span class="tab-text">Comparaci√≥n</span>
                </button>
                <button class="gastos-tab" onclick="cambiarTabGastos('presupuesto')" data-tab="presupuesto">
                    <span class="tab-icon">
                        <ion-icon name="wallet"></ion-icon>
                    </span>
                    <span class="tab-text">Presupuesto</span>
                </button>
                <button class="gastos-tab" onclick="cambiarTabGastos('iva')" data-tab="iva">
                    <span class="tab-icon">
                        <ion-icon name="server"></ion-icon>
                    </span>
                    <span class="tab-text">IVA</span>
                </button>
            </div>

            <!-- Contenido de cada tab -->
            <div class="gastos-content">
                <!-- Tab 1: Top 5 Art√≠culos -->
                <div class="gastos-panel active" id="panel-top-articulos">
                    <div class="panel-header">
                        <h3 class="panel-title">Top 5 Art√≠culos con Mayor Gasto</h3>
                        <p class="panel-subtitle">Los productos en los que m√°s has gastado</p>
                        <p style="font-size: 12px; color: var(--text-muted); margin-top: 8px; font-style: italic;">
                            üí° Los datos mostrados corresponden a la √∫ltima lista que guardaste
                        </p>
                    </div>
                    <div class="chart-container">
                        <canvas id="chartTopArticulos"></canvas>
                    </div>
                    <div class="panel-stats" id="statsTopArticulos"></div>
                </div>

                <!-- Tab 2: Gastos por Categor√≠a -->
                <div class="gastos-panel" id="panel-por-categoria">
                    <div class="panel-header">
                        <h3 class="panel-title">Gastos por Categor√≠a</h3>
                        <p class="panel-subtitle">Distribuci√≥n de tu dinero por categor√≠as</p>
                        <p style="font-size: 12px; color: var(--text-muted); margin-top: 8px; font-style: italic;">
                            üí° Los datos mostrados corresponden a la √∫ltima lista que guardaste
                        </p>
                    </div>
                    <div class="chart-container">
                        <canvas id="chartCategorias"></canvas>
                    </div>
                    <div class="panel-stats" id="statsCategorias"></div>
                </div>

                <!-- Tab 3: Impacto de Descuentos -->
                <div class="gastos-panel" id="panel-descuentos">
                    <div class="panel-header">
                        <h3 class="panel-title">Impacto de Descuentos</h3>
                        <p class="panel-subtitle">Cu√°nto has ahorrado con promociones</p>
                        <p style="font-size: 12px; color: var(--text-muted); margin-top: 8px; font-style: italic;">
                            üí° Los datos mostrados corresponden a la √∫ltima lista que guardaste
                        </p>
                    </div>
                    <div class="descuentos-cards">
                        <div class="stat-card">
                            <div class="stat-card-icon">
                                <ion-icon name="pricetag"></ion-icon>
                            </div>
                            <div class="stat-card-content">
                                <div class="stat-card-label">Total Ahorrado</div>
                                <div class="stat-card-value" id="totalAhorrado">$0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-icon">
                                <ion-icon name="basket"></ion-icon>
                            </div>
                            <div class="stat-card-content">
                                <div class="stat-card-label">Productos con Descuento</div>
                                <div class="stat-card-value" id="productosConDescuento">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-icon">
                                <ion-icon name="stats-chart"></ion-icon>
                            </div>
                            <div class="stat-card-content">
                                <div class="stat-card-label">% de Ahorro Promedio</div>
                                <div class="stat-card-value" id="porcentajeAhorro">0%</div>
                            </div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="chartDescuentos"></canvas>
                    </div>
                </div>

                <!-- Tab 4: Comparaci√≥n con Listas Anteriores -->
                <div class="gastos-panel" id="panel-comparacion">
                    <div class="panel-header">
                        <h3 class="panel-title">Comparaci√≥n con Listas Anteriores</h3>
                        <p class="panel-subtitle">Evoluci√≥n de tus gastos en el tiempo</p>
                        <p style="font-size: 12px; color: var(--text-muted); margin-top: 8px; font-style: italic;">
                            üí° Se comparan las dos √∫ltimas compras que guardaste
                        </p>
                    </div>
                    <div class="chart-container">
                        <canvas id="chartComparacion"></canvas>
                    </div>
                    <div class="panel-stats" id="statsComparacion"></div>
                </div>

                <!-- Tab 5: Presupuesto vs Real -->
                <div class="gastos-panel" id="panel-presupuesto">
                    <div class="panel-header">
                        <h3 class="panel-title">Presupuesto vs Gasto Real</h3>
                        <p class="panel-subtitle">An√°lisis de tu lista m√°s reciente</p>
                        <p style="font-size: 12px; color: var(--text-muted); margin-top: 8px; font-style: italic;">
                            üí° Los datos mostrados corresponden al √∫ltimo presupuesto que ingresaste en tu lista guardada
                        </p>
                    </div>
                    <div class="presupuesto-cards">
                        <div class="stat-card">
                            <div class="stat-card-icon">
                                <ion-icon name="wallet"></ion-icon>
                            </div>
                            <div class="stat-card-content">
                                <div class="stat-card-label">Presupuesto</div>
                                <div class="stat-card-value" id="presupuestoPlaneado">$0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-icon">
                                <ion-icon name="card"></ion-icon>
                            </div>
                            <div class="stat-card-content">
                                <div class="stat-card-label">Gasto Real</div>
                                <div class="stat-card-value" id="gastoReal">$0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-icon">
                                <ion-icon name="add-circle"></ion-icon>
                            </div>
                            <div class="stat-card-content">
                                <div class="stat-card-label">Diferencia</div>
                                <div class="stat-card-value" id="diferencia">$0</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tab 6: IVA -->
                <div class="gastos-panel" id="panel-iva">
                    <div class="panel-header">
                        <h3 class="panel-title">Estad√≠sticas de IVA</h3>
                        <p class="panel-subtitle">IVA total pagado en tus compras</p>
                        <p style="font-size: 12px; color: var(--text-muted); margin-top: 8px; font-style: italic;">
                            üí° Los datos son la suma acumulada de todos los IVA que has registrado en tus compras guardadas
                        </p>
                    </div>
                    
                    <div class="presupuesto-cards">
                        <div class="stat-card">
                            <div class="stat-card-icon">
                                <ion-icon name="wallet"></ion-icon>
                            </div>
                            <div class="stat-card-content">
                                <div class="stat-card-label">IVA Total Pagado</div>
                                <div class="stat-card-value" id="totalIVAPagado">$0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-icon">
                                <ion-icon name="list"></ion-icon>
                            </div>
                            <div class="stat-card-content">
                                <div class="stat-card-label">N√∫mero de Compras</div>
                                <div class="stat-card-value" id="numeroComprasIVA">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-icon">
                                <ion-icon name="wallet"></ion-icon>
                            </div>
                            <div class="stat-card-content">
                                <div class="stat-card-label">IVA Promedio</div>
                                <div class="stat-card-value" id="promedioIVA">$0</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 24px;">
                        <h4 style="font-size: 14px; font-weight: 700; color: var(--text-primary); margin-bottom: 12px;">√öltimas compras registradas:</h4>
                        <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px; padding: 10px; background: rgba(57, 255, 20, 0.05); border-radius: 8px; border-left: 3px solid var(--primary-color);">
                            üìå Se muestran solo los <strong>√∫ltimos 5 registros</strong>. Los registros se conservan autom√°ticamente para tus estad√≠sticas, pero la visualizaci√≥n se limita a los m√°s recientes.
                        </p>
                        <div id="listaIVACompras" style="max-height: 300px; overflow-y: auto;">
                            <p style="font-size: 12px; color: var(--text-muted); text-align: center; padding: 20px;">
                                No hay registros de IVA a√∫n
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Configuraci√≥n -->
        <div class="content-section" id="seccionConfiguracion">
            <div class="config-section">
                <div class="config-title">üåç Idioma</div>
                <div class="config-option">
                    <select class="form-input" id="selectIdioma" onchange="cambiarIdiomaTemp()">
                        <option value="es">Espa√±ol</option>
                        <option value="en">English</option>
                    </select>
                </div>
            </div>

            <div class="config-section">
                <div class="config-title">üìù Campos del Formulario</div>
                <div class="config-description">Selecciona qu√© campos quieres mostrar al agregar art√≠culos</div>
                
                <div class="config-option config-checkbox">
                    <label class="checkbox-label">
                        <input type="checkbox" id="checkMarca" onchange="toggleCampo('marca')">
                        <span>Marca</span>
                    </label>
                </div>
                
                <div class="config-option config-checkbox">
                    <label class="checkbox-label">
                        <input type="checkbox" id="checkCategoria" onchange="toggleCampo('categoria')">
                        <span>Categor√≠a</span>
                    </label>
                </div>
                
                <div class="config-option config-checkbox">
                    <label class="checkbox-label">
                        <input type="checkbox" id="checkNota" onchange="toggleCampo('nota')">
                        <span>Nota</span>
                    </label>
                </div>
                
                <div class="config-option config-checkbox">
                    <label class="checkbox-label">
                        <input type="checkbox" id="checkPromociones" onchange="toggleCampo('promociones')">
                        <span>Promociones/Descuentos</span>
                    </label>
                </div>
            </div>

            <div class="config-section">
                <div class="config-title">üí∞ Formato de Precios</div>
                <div class="config-option config-checkbox">
                    <label class="checkbox-label">
                        <input type="checkbox" id="checkDecimales" onchange="toggleDecimales()">
                        <span>Mostrar decimales ($58,000.00)</span>
                    </label>
                </div>
            </div>

        </div>
    </div>

    <!-- Footer con elementos fijos para INICIO -->
    <div class="bottom-fixed-container">
        <!-- 3. Bot√≥n agregar art√≠culo -->
        <button class="btn btn-primary btn-add-item" onclick="abrirModalAgregar()">
            <svg style="width: 20px; height: 20px; display: inline-block; vertical-align: middle; margin-right: 8px;" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
            </svg>
            Agregar art√≠culo
        </button>

        <!-- 4. Presupuesto disponible / Sin presupuesto -->
        <div class="budget-card" id="budgetCard">
            <!-- Estado: Sin presupuesto establecido -->
            <div id="budgetCardEmpty" style="display: none;">
                <div style="text-align: center; padding: 8px 0;">
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">Sin presupuesto establecido</div>
                    <button class="btn btn-secondary" onclick="abrirModalPresupuesto()" style="width: 100%; padding: 8px;">
                        Establecer presupuesto
                    </button>
                </div>
            </div>
            
            <!-- Estado: Con presupuesto -->
            <div id="budgetCardFull" style="display: none;">
                <div class="budget-header">
                    <span class="budget-label">Presupuesto disponible</span>
                    <div class="budget-buttons-group">
                        <button class="budget-edit-btn" onclick="abrirModalPresupuesto()" title="Editar presupuesto">
                            <ion-icon name="create"></ion-icon>
                        </button>
                        <button class="budget-delete-btn" onclick="confirmarBorrarPresupuesto()" title="Borrar presupuesto">
                            <ion-icon name="trash"></ion-icon>
                        </button>
                        <button class="budget-edit-btn" onclick="abrirModalAgregarIVA()" title="Agregar IVA">
                            <ion-icon name="server"></ion-icon>
                        </button>
                        <button class="budget-edit-btn" onclick="abrirModalGuardarPresupuesto()" title="Guardar presupuesto">
                            <ion-icon name="cash"></ion-icon>
                        </button>
                    </div>
                </div>
                <div class="budget-amount" id="budgetAmount">$0</div>
                <div class="budget-progress-bar">
                    <div class="budget-progress-fill low" id="budgetProgressFill" style="width: 0%"></div>
                </div>
                <div class="budget-remaining" id="budgetRemaining"></div>
            </div>
        </div>

        <!-- 5. Resumen en tres columnas -->
        <div class="summary-grid">
            <div class="summary-col">
                <div class="summary-col-label">Subtotal</div>
                <div class="summary-col-value" id="subtotalDisplay">$0</div>
            </div>
            <div class="summary-col">
                <div class="summary-col-label">Descuento</div>
                <div class="summary-col-value" id="descuentosDisplay">-$0</div>
            </div>
            <div class="summary-col summary-col-total">
                <div class="summary-col-label">Total</div>
                <div class="summary-col-value" id="totalDisplay">$0</div>
            </div>
        </div>
    </div>

    <!-- Modal Agregar/Editar Art√≠culo -->
    <div class="modal" id="modalArticulo">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalArticuloTitulo">Agregar art√≠culo</div>
                <button class="modal-close" onclick="cerrarModalArticulo()">
                    <ion-icon name="close"></ion-icon>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Nombre del producto</label>
                    <input type="text" class="form-input" id="nombreProducto" placeholder="Escribe el nombre del producto">
                </div>

                <div class="form-group" id="campoMarca" style="display: none;">
                    <label class="form-label">Marca (opcional)</label>
                    <input type="text" class="form-input" id="marcaProducto" placeholder="Ej: Alpina, Colanta, etc.">
                </div>

                <div class="form-group">
                    <label class="form-label">Cantidad</label>
                    <div class="form-row">
                        <input type="number" class="form-input" id="cantidadProducto" placeholder="1" min="0.01" step="0.01">
                        <select class="form-input" id="tipoUnidad">
                            <option value="unidad">Unidad</option>
                            <option value="libras">Libras</option>
                            <option value="kilogramos">Kilogramos</option>
                            <option value="gramos">Gramos</option>
                            <option value="litros">Litros</option>
                            <option value="mililitros">Mililitros</option>
                            <option value="galones">Galones</option>
                            <option value="lata">Lata</option>
                            <option value="paquete">Paquete</option>
                            <option value="botella">Botella</option>
                        </select>
                    </div>
                </div>

                <div class="form-group" id="campoCategoria" style="display: none;">
                    <label class="form-label">Categor√≠a (opcional)</label>
                    <select class="form-input" id="categoriaProducto">
                        <option value="">Sin categor√≠a</option>
                        <option value="lacteos">ü•õ L√°cteos</option>
                        <option value="panaderia">üçû Panader√≠a</option>
                        <option value="congelados">üßä Congelados</option>
                        <option value="cereales">üåæ Cereales</option>
                        <option value="papeleria">üìù Papeler√≠a</option>
                        <option value="salud">üíä Salud</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Precio</label>
                    <input type="text" class="form-input" id="precioProducto" placeholder="0">
                </div>

                <div class="form-group" id="campoNota" style="display: none;">
                    <label class="form-label">Nota (opcional)</label>
                    <input type="text" class="form-input" id="notaProducto" placeholder="Agregar una nota...">
                </div>

                <div class="form-group" id="campoPromociones" style="display: none;">
                    <div class="checkbox-group" onclick="togglePromo()">
                        <input type="checkbox" id="tienePromo">
                        <label>Tiene promoci√≥n o descuento</label>
                    </div>
                </div>

                <div class="promo-options" id="promoOptions">
                    <div class="radio-group">
                        <div class="radio-option" id="opcionPromocion" onclick="seleccionarTipoPromo('promocion')">
                            Promoci√≥n
                        </div>
                        <div class="radio-option" id="opcionDescuento" onclick="seleccionarTipoPromo('descuento')">
                            Descuento
                        </div>
                    </div>

                    <div class="form-group" id="campoPromocion" style="display: none;">
                        <label class="form-label">Tipo de promoci√≥n</label>
                        <input type="text" class="form-input" id="tipoPromocion" placeholder="Ej: 2x1, 3x2, etc.">
                    </div>

                    <div class="form-group" id="campoDescuento" style="display: none;">
                        <label class="form-label">Valor del descuento (%)</label>
                        <input type="number" class="form-input" id="valorDescuento" placeholder="10" min="0" max="100">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="cerrarModalArticulo()">Cancelar</button>
                <button class="btn btn-primary" onclick="confirmarArticulo()">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal Guardar Lista -->
    <div class="modal" id="modalGuardar">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <svg style="width: 18px; height: 18px; display: inline-block; vertical-align: middle; margin-right: 6px;" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H16L21 8V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M17 21V13H7V21M7 3V8H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Guardar Lista
                </div>
                <button class="modal-close" style="display: flex; align-items: center; justify-content: center;" onclick="cerrarModalGuardar()">
                    <ion-icon name="close"></ion-icon>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Nombre de la lista</label>
                    <input type="text" class="form-input" id="nombreLista" placeholder="Ej: Compras del mes" oninput="verificarNombreLista()">
                </div>
                <!-- Mensaje de error si el nombre existe -->
                <div id="mensajeErrorNombre" style="display: none; color: #ff4444; font-size: 13px; margin-top: 8px; padding: 8px; background: rgba(255, 68, 68, 0.1); border-radius: 6px; border-left: 3px solid #ff4444;">
                    ‚ö†Ô∏è Este nombre ya se encuentra registrado
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="cerrarModalGuardar()">Cancelar</button>
                <button class="btn btn-primary" id="btnGuardarLista" onclick="confirmarGuardarLista()">Guardar</button>
                <button class="btn btn-delete" id="btnSobrescribir" style="display: none;" onclick="sobrescribirLista()">Sobrescribir</button>
            </div>
        </div>
    </div>

    <!-- Modal Presupuesto -->
    <div class="modal" id="modalPresupuesto">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalPresupuestoTitle">
                    <svg style="width: 18px; height: 18px; display: inline-block; vertical-align: middle; margin-right: 6px;" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                        <path d="M12 6V12L16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    Agregar Presupuesto
                </div>
                <button class="modal-close" style="display: flex; align-items: center; justify-content: center;" onclick="cerrarModalPresupuesto()">
                    <ion-icon name="close"></ion-icon>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Presupuesto disponible</label>
                    <input type="text" class="form-input" id="inputPresupuesto" placeholder="0">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="cerrarModalPresupuesto()">Cancelar</button>
                <button class="btn btn-primary" onclick="confirmarPresupuesto()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal Guardar Presupuesto -->
    <div class="modal" id="modalGuardarPresupuesto">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <svg style="width: 20px; height: 20px; display: inline-block; vertical-align: middle; margin-right: 8px;" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M19 12V19C19 19.5304 18.7893 20.0391 18.4142 20.4142C18.0391 20.7893 17.5304 21 17 21H7C6.46957 21 5.96086 20.7893 5.58579 20.4142C5.21071 20.0391 5 19.5304 5 19V5C5 4.46957 5.21071 3.96086 5.58579 3.58579C5.96086 3.21071 6.46957 3 7 3H12M19 3V9M19 3L12 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Guardar Presupuesto
                </div>
                <button class="modal-close" style="display: flex; align-items: center; justify-content: center;" onclick="cerrarModalGuardarPresupuesto()">
                    <ion-icon name="close"></ion-icon>
                </button>
            </div>
            <div class="modal-body">
                <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">
                    ¬øDeseas guardar este presupuesto? Se registrar√° en la pesta√±a "Presupuesto" de "Mis Gastos".
                </p>
                <div id="guardarPresupuestoInfo" style="background: rgba(57, 255, 20, 0.1); padding: 14px; border-radius: 8px; border-left: 4px solid var(--primary-color);">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px;">
                        <div>
                            <p style="color: var(--text-muted); margin-bottom: 4px;">Presupuesto:</p>
                            <p style="font-weight: 700; font-size: 16px; color: var(--primary-color);" id="presuGuardarMonto">$0</p>
                        </div>
                        <div>
                            <p style="color: var(--text-muted); margin-bottom: 4px;">Gasto Real:</p>
                            <p style="font-weight: 700; font-size: 16px; color: var(--primary-color);" id="gastoGuardarMonto">$0</p>
                        </div>
                        <div>
                            <p style="color: var(--text-muted); margin-bottom: 4px;">Disponible:</p>
                            <p style="font-weight: 700; font-size: 16px;" id="disponibleGuardarMonto">$0</p>
                        </div>
                        <div>
                            <p style="color: var(--text-muted); margin-bottom: 4px;">Productos:</p>
                            <p style="font-weight: 700; font-size: 16px; color: var(--primary-color);" id="productosGuardarCantidad">0</p>
                        </div>
                    </div>
                </div>
                <p style="font-size: 12px; color: var(--text-muted); margin-top: 12px; font-style: italic;">
                    üí° Nota: El IVA se guarda solo si guardas la lista completa.
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="cerrarModalGuardarPresupuesto()">Cancelar</button>
                <button class="btn btn-primary" onclick="confirmarGuardarPresupuesto()">Guardar Presupuesto</button>
            </div>
        </div>
    </div>

    <!-- Modal Agregar IVA -->
    <div class="modal" id="modalAgregarIVA">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalAgregarIVATitle">
                    <svg style="width: 20px; height: 20px; display: inline-block; vertical-align: middle; margin-right: 8px;" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12C4 7.59 7.59 4 12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20ZM12.5 7H11V13L16.2 16.2L17 15.3L12.5 12.4V7Z" fill="currentColor"/>
                    </svg>
                    Calcular total con IVA
                </div>
                <button class="modal-close" style="display: flex; align-items: center; justify-content: center;" onclick="cerrarModalAgregarIVA()">√ó</button>
            </div>
            <div class="modal-body">
                <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">
                    Ingresa el IVA total cobrado en la factura del supermercado. Este campo es <strong>opcional</strong>.
                </p>
                <label class="form-label">IVA Total (Opcional)</label>
                <input type="text" class="form-input" id="inputIVAModalTotal" placeholder="Ej: 11.400" oninput="actualizarEstadoBotonesIVA()">
                
                <!-- Mostrar el total con IVA -->
                <div id="totalConIVADisplay" style="display: none; background: rgba(57, 255, 20, 0.1); padding: 14px; border-radius: 8px; margin-top: 16px; border-left: 4px solid var(--primary-color);">
                    <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">Total de la compra con IVA:</p>
                    <p style="font-size: 20px; font-weight: 700; color: var(--primary-color);" id="totalConIVAValor">$0</p>
                </div>
            </div>
            <div class="modal-footer" style="display: flex; flex-direction: column; gap: 12px;">
                <button class="btn btn-primary" id="btnGuardarListaConIVA" onclick="abrirConfirmacionPagoIVA()" disabled style="opacity: 0.5; cursor: not-allowed;">
                    <svg style="width: 16px; height: 16px; display: inline-block; vertical-align: middle; margin-right: 6px;" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M19 21H5C3.9 21 3 20.1 3 19V5C3 3.9 3.9 3 5 3H11L13 5H19C20.1 5 21 5.9 21 7H21V19C21 20.1 20.1 21 19 21ZM19 9H5V19H19V9Z" fill="currentColor"/>
                    </svg>
                    Guardar lista con IVA
                </button>
                <div style="display: flex; gap: 12px;">
                    <button class="btn btn-secondary" onclick="cerrarModalAgregarIVA()" style="flex: 1;">Cancelar</button>
                    <button class="btn btn-secondary" onclick="confirmarAgregarIVA()" style="flex: 1;">Solo visualizar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Confirmaci√≥n de Pago de IVA -->
    <div class="modal" id="modalConfirmacionPagoIVA">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <svg style="width: 20px; height: 20px; display: inline-block; vertical-align: middle; margin-right: 8px;" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM10 17L5 12L6.41 10.59L10 14.17L17.59 6.58L19 8L10 17Z" fill="currentColor"/>
                    </svg>
                    ¬øYa pagaste este IVA?
                </div>
                <button class="modal-close" style="display: flex; align-items: center; justify-content: center;" onclick="cerrarConfirmacionPagoIVA()">√ó</button>
            </div>
            <div class="modal-body">
                <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 20px;">
                    Confirma si ya pagaste este IVA en tu factura para registrarlo en tu historial de compras.
                </p>
                
                <!-- Resumen del pago -->
                <div style="background: var(--bg-card); padding: 14px; border-radius: 8px; border: 1px solid var(--border-color); margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-size: 12px; color: var(--text-muted);">Subtotal:</span>
                        <span style="font-size: 12px; color: var(--text-secondary);" id="ivaConfirmSubtotal">$0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-size: 12px; color: var(--text-muted);">IVA:</span>
                        <span style="font-size: 12px; color: var(--text-secondary);" id="ivaConfirmIVA">$0</span>
                    </div>
                    <div style="border-top: 1px solid var(--border-color); padding-top: 8px; display: flex; justify-content: space-between;">
                        <span style="font-size: 13px; font-weight: 600; color: var(--text-primary);">Total pagado:</span>
                        <span style="font-size: 13px; font-weight: 700; color: var(--primary-color);" id="ivaConfirmTotal">$0</span>
                    </div>
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 8px; text-align: center;">
                        Hoy, <span id="ivaConfirmFecha"></span>
                    </div>
                </div>
                
                <p style="font-size: 12px; color: var(--text-muted); text-align: center;">
                    Esto se registrar√° en el tab <strong>"IVA"</strong> en "Mis Gastos"
                </p>
            </div>
            <div class="modal-footer" style="display: flex; gap: 12px;">
                <button class="btn btn-secondary" onclick="cerrarConfirmacionPagoIVA()" style="flex: 1;">No lo pagu√© a√∫n</button>
                <button class="btn btn-primary" onclick="confirmarPagoIVA()" style="flex: 1;">S√≠, ya lo pagu√©</button>
            </div>
        </div>
    </div>

    <!-- Overlay para Dialog de Confirmaci√≥n -->
    <div class="confirm-dialog-overlay" id="confirmDialogOverlay"></div>

    <!-- Confirm Dialog -->
    <div class="confirm-dialog" id="confirmDialog">
        <button class="confirm-close-btn" onclick="cerrarConfirm()" title="Cerrar">
            <ion-icon name="close"></ion-icon>
        </button>
        <div class="confirm-title" id="confirmTitle"></div>
        <div class="confirm-text" id="confirmText"></div>
        <div class="confirm-actions">
            <button class="btn btn-primary" id="confirmButton" style="display: none;">Seguro</button>
            <button class="btn btn-primary" id="confirmButtonSecond" style="display: none;"></button>
        </div>
    </div>

    <!-- Modal Resumen -->
    <div class="modal-resumen" id="modalResumen">
        <div class="resumen-container" id="resumenContainer">
            <div class="resumen-header">
                <div class="resumen-header-content">
                    <div class="resumen-title" id="resumenTitulo">Lista de Compras</div>
                    <div class="resumen-date" id="resumenFecha"></div>
                </div>
                <button class="resumen-close-btn" onclick="cerrarResumen()" title="Cerrar">√ó</button>
            </div>
            
            <div class="resumen-items" id="resumenItems"></div>
            
            <div class="resumen-summary" id="resumenSummary"></div>
            
            <div class="resumen-actions">
                <button class="btn btn-secondary" onclick="compartirResumen()" title="Compartir en redes sociales o apps">
                    <svg style="width: 16px; height: 16px; display: inline-block; vertical-align: middle; margin-right: 4px;" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M4 12V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V12M12 4V16M12 4L7 9M12 4L17 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Compartir
                </button>
                <button class="btn btn-primary" onclick="descargarResumen()">
                    <svg style="width: 16px; height: 16px; display: inline-block; vertical-align: middle; margin-right: 4px;" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M7 10L12 15L17 10M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Descargar PDF
                </button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let productos = [];
        let editandoIndex = -1;
        let idioma = 'es';
        let colorTema = '#39ff14';
        let tipoPromoSeleccionado = null;
        let presupuesto = 0;
        let ivaActual = 0; // IVA de la lista actual
        let temaActual = 'dark';
        let mostrarCampos = {
            marca: false,
            categoria: false,
            nota: false,
            promociones: false
        };
        let mostrarDecimales = false;
        
        // Variables temporales para configuraci√≥n
        let mostrarCamposTemp = {
            marca: false,
            categoria: false,
            nota: false,
            promociones: false
        };
        let mostrarDecimalesTemp = false;
        let idiomaTemp = 'es';

        // Categor√≠as con emojis
        const categoriaEmojis = {
            'lacteos': 'ü•õ',
            'panaderia': 'üçû',
            'congelados': 'üßä',
            'cereales': 'üåæ',
            'papeleria': 'üìù',
            'salud': 'üíä',
            '': 'üì¶'
        };

        // S√≠mbolos de moneda
        // Traducciones
        const traducciones = {
            es: {
                inicio: 'Inicio',
                listasGuardadas: 'Listas guardadas',
                graficos: 'Gr√°ficos',
                configuracion: 'Configuraci√≥n',
                subtotal: 'Subtotal:',
                descuentos: 'Descuentos:',
                total: 'Total:',
                guardarLista: 'Guardar lista',
                limpiarTodo: 'Limpiar todo',
                agregarArticulo: 'Agregar art√≠culo',
                sinArticulos: 'No hay art√≠culos en la lista',
                editar: 'Editar',
                eliminar: 'Eliminar'
            },
            en: {
                inicio: 'Home',
                listasGuardadas: 'Saved Lists',
                graficos: 'Charts',
                configuracion: 'Settings',
                subtotal: 'Subtotal:',
                descuentos: 'Discounts:',
                total: 'Total:',
                guardarLista: 'Save list',
                limpiarTodo: 'Clear all',
                agregarArticulo: 'Add item',
                sinArticulos: 'No items in the list',
                editar: 'Edit',
                eliminar: 'Delete'
            }
        };

        // Inicializar
        function init() {
            cargarConfiguracion();
            cargarProductos();
            
            // Recuperar lista cargada si existe
            const listaGuardadaCargada = localStorage.getItem('listaActuallyCargada');
            if (listaGuardadaCargada) {
                try {
                    listaActuallyCargada = JSON.parse(listaGuardadaCargada);
                } catch (e) {
                    listaActuallyCargada = null;
                }
            }
            
            renderizarProductos();
            actualizarIndicadorLista();
            actualizarTotales();
            renderizarListasGuardadas();
            aplicarTraducciones();
            actualizarEstadoPresupuesto();
            actualizarInfoIVAPresupuesto();
            
            // Cargar IVA guardado si existe
            ivaActual = parseFloat(localStorage.getItem('ivaActual') || 0);
            
            // Mostrar footer en INICIO
            const bottomFixedContainer = document.querySelector('.bottom-fixed-container');
            if (document.getElementById('seccionInicio').classList.contains('active')) {
                bottomFixedContainer.classList.add('visible');
                // Actualizar altura despu√©s de mostrar
                setTimeout(actualizarAltoBottomFixedContainer, 0);
            }
        }

        // Sidebar
        function toggleSidebar() {
            // Bloquear si hay un modal confirmaci√≥n activo
            const confirmDialog = document.getElementById('confirmDialog');
            if (confirmDialog && confirmDialog.classList.contains('active')) {
                return;
            }
            
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
            
            // Bloquear/desbloquear scroll
            if (sidebar.classList.contains('active')) {
                document.body.classList.add('no-scroll');
            } else {
                document.body.classList.remove('no-scroll');
            }
        }
        
        // Tema d√≠a/noche
        function toggleTheme() {
            temaActual = temaActual === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', temaActual);
            localStorage.setItem('tema', temaActual);
            
            // Re-renderizar gr√°ficos con nuevos colores
            if (document.getElementById('seccionGraficos').classList.contains('active')) {
                const activeTab = document.querySelector('.gastos-tab.active');
                if (activeTab) {
                    const tabData = activeTab.getAttribute('data-tab');
                    cambiarTabGastos(tabData);
                }
            }
        }

        function actualizarAltoBottomFixedContainer() {
            const bottomFixedContainer = document.querySelector('.bottom-fixed-container');
            if (bottomFixedContainer && bottomFixedContainer.classList.contains('visible')) {
                const altura = bottomFixedContainer.offsetHeight;
                document.documentElement.style.setProperty('--bottom-fixed-height', altura + 'px');
            } else {
                document.documentElement.style.setProperty('--bottom-fixed-height', '0px');
            }
        }

        function navigateTo(seccion) {
            /* ============================================================
               FUNCI√ìN DE NAVEGACI√ìN - Controla la visibilidad de secciones
               ============================================================
               PATR√ìN: Remover .active de TODAS las secciones primero,
                       luego agregar .active SOLO a la secci√≥n destino
               
               REGLA CR√çTICA: NUNCA agregar display: flex directamente a 
                              los selectores #seccionXXX
               
               El display: flex se aplica autom√°ticamente cuando la secci√≥n
               tiene la clase .active (definido en CSS)
               ============================================================ */
            
            // Cerrar sidebar
            const sidebarElement = document.getElementById('sidebar');
            const overlayElement = document.getElementById('sidebarOverlay');
            if (sidebarElement && sidebarElement.classList.contains('active')) {
                toggleSidebar();
            }

            // Actualizar men√∫
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Activar el men√∫ correcto seg√∫n la secci√≥n
            const menuItems = document.querySelectorAll('.menu-item');
            menuItems.forEach(item => {
                const onclick = item.getAttribute('onclick');
                if (onclick && onclick.includes(`'${seccion}'`)) {
                    item.classList.add('active');
                }
            });

            // Mostrar secci√≥n
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });

            // Controlar visibilidad del footer
            const bottomFixedContainer = document.querySelector('.bottom-fixed-container');
            if (seccion === 'inicio') {
                document.getElementById('seccionInicio').classList.add('active');
                bottomFixedContainer.classList.add('visible');
                // Actualizar altura despu√©s de mostrar el footer
                setTimeout(actualizarAltoBottomFixedContainer, 0);
            } else {
                if (seccion === 'listas') {
                    document.getElementById('seccionListas').classList.add('active');
                    renderizarListasGuardadas();
                } else if (seccion === 'graficos') {
                    document.getElementById('seccionGraficos').classList.add('active');
                    renderizarGraficos();
                } else if (seccion === 'configuracion') {
                    document.getElementById('seccionConfiguracion').classList.add('active');
                }
                bottomFixedContainer.classList.remove('visible');
                // Actualizar altura despu√©s de ocultar el footer
                actualizarAltoBottomFixedContainer();
            }
            
            // Validar que la navegaci√≥n fue correcta
            validarVisibilidadSecciones();
        }
        
        /* ============================================================
           VALIDACI√ìN DE ARQUITECTURA - Detectar errores de visibilidad
           ============================================================
           Prop√≥sito: Verificar que solo una secci√≥n est√© visible
           Uso: Se ejecuta autom√°ticamente en cada navegaci√≥n
           Ventaja: Detecta problemas en desarrollo antes de llegar a producci√≥n
           ============================================================ */
        function validarVisibilidadSecciones() {
            const secciones = [
                { id: 'seccionInicio', nombre: 'Inicio' },
                { id: 'seccionListas', nombre: 'Listas Guardadas' },
                { id: 'seccionGraficos', nombre: 'Mis Gastos' },
                { id: 'seccionConfiguracion', nombre: 'Configuraci√≥n' }
            ];
            
            const activas = secciones.filter(s => 
                document.getElementById(s.id)?.classList.contains('active')
            );
            
            // Error: M√°s de una secci√≥n activa (DEBE EVITARSE)
            if (activas.length > 1) {
                console.error('‚ùå ERROR DE ARQUITECTURA: M√∫ltiples secciones activas simult√°neamente:',
                    activas.map(s => s.nombre));
            }
            
            // Error: Ninguna secci√≥n activa (DEBE EVITARSE)
            if (activas.length === 0) {
                console.error('‚ùå ERROR DE ARQUITECTURA: Ninguna secci√≥n visible');
            }
            
            // Correcto: Solo una secci√≥n activa
            if (activas.length === 1) {
                console.log('‚úÖ Navegaci√≥n correcta ‚Üí ' + activas[0].nombre);
            }
        }

        // Modal Art√≠culo
        function abrirModalAgregar() {
            editandoIndex = -1;
            document.getElementById('modalArticuloTitulo').textContent = 'Agregar art√≠culo';
            limpiarFormulario();
            aplicarVisibilidadCampos();
            document.getElementById('modalArticulo').classList.add('active');
            document.body.classList.add('no-scroll');
        }

        function abrirModalEditar(index) {
            editandoIndex = index;
            document.getElementById('modalArticuloTitulo').textContent = 'Editar art√≠culo';
            const producto = productos[index];
            
            document.getElementById('nombreProducto').value = producto.nombre;
            document.getElementById('marcaProducto').value = producto.marca || '';
            document.getElementById('cantidadProducto').value = producto.cantidad;
            document.getElementById('tipoUnidad').value = producto.unidad;
            document.getElementById('categoriaProducto').value = producto.categoria || '';
            document.getElementById('precioProducto').value = formatearNumero(producto.precio);
            document.getElementById('notaProducto').value = producto.nota || '';
            
            if (producto.tienePromo) {
                document.getElementById('tienePromo').checked = true;
                document.getElementById('promoOptions').classList.add('active');
                seleccionarTipoPromo(producto.tipoPromo);
                if (producto.tipoPromo === 'promocion') {
                    document.getElementById('tipoPromocion').value = producto.descripcionPromo || '';
                } else {
                    document.getElementById('valorDescuento').value = producto.valorDescuento || '';
                }
            }
            
            aplicarVisibilidadCampos();
            document.getElementById('modalArticulo').classList.add('active');
            document.body.classList.add('no-scroll');
        }

        function cerrarModalArticulo() {
            document.getElementById('modalArticulo').classList.remove('active');
            document.body.classList.remove('no-scroll');
            limpiarFormulario();
        }

        function limpiarFormulario() {
            document.getElementById('nombreProducto').value = '';
            document.getElementById('marcaProducto').value = '';
            document.getElementById('cantidadProducto').value = '';
            document.getElementById('tipoUnidad').value = 'unidad';
            document.getElementById('categoriaProducto').value = '';
            document.getElementById('precioProducto').value = '';
            document.getElementById('notaProducto').value = '';
            document.getElementById('tienePromo').checked = false;
            document.getElementById('promoOptions').classList.remove('active');
            document.getElementById('tipoPromocion').value = '';
            document.getElementById('valorDescuento').value = '';
            tipoPromoSeleccionado = null;
        }

        function togglePromo() {
            const checkbox = document.getElementById('tienePromo');
            const promoOptions = document.getElementById('promoOptions');
            checkbox.checked = !checkbox.checked;
            
            if (checkbox.checked) {
                promoOptions.classList.add('active');
            } else {
                promoOptions.classList.remove('active');
                tipoPromoSeleccionado = null;
            }
        }

        function seleccionarTipoPromo(tipo) {
            tipoPromoSeleccionado = tipo;
            document.getElementById('opcionPromocion').classList.remove('selected');
            document.getElementById('opcionDescuento').classList.remove('selected');
            document.getElementById('campoPromocion').style.display = 'none';
            document.getElementById('campoDescuento').style.display = 'none';
            
            if (tipo === 'promocion') {
                document.getElementById('opcionPromocion').classList.add('selected');
                document.getElementById('campoPromocion').style.display = 'block';
            } else if (tipo === 'descuento') {
                document.getElementById('opcionDescuento').classList.add('selected');
                document.getElementById('campoDescuento').style.display = 'block';
            }
        }

        function confirmarArticulo() {
            const nombre = document.getElementById('nombreProducto').value.trim();
            
            if (!nombre) {
                mostrarAlertaModal('‚ö†Ô∏è Campo requerido', 'El nombre del producto es obligatorio');
                return;
            }

            const producto = {
                nombre: nombre,
                marca: document.getElementById('marcaProducto').value.trim(),
                cantidad: parseFloat(document.getElementById('cantidadProducto').value) || 1,
                unidad: document.getElementById('tipoUnidad').value,
                categoria: document.getElementById('categoriaProducto').value,
                precio: limpiarNumero(document.getElementById('precioProducto').value),
                nota: document.getElementById('notaProducto').value.trim(),
                tienePromo: document.getElementById('tienePromo').checked,
                tipoPromo: tipoPromoSeleccionado,
                descripcionPromo: document.getElementById('tipoPromocion').value.trim(),
                valorDescuento: parseFloat(document.getElementById('valorDescuento').value) || 0
            };

            // Calcular total
            let total = producto.cantidad * producto.precio;
            let descuento = 0;

            if (producto.tienePromo && producto.tipoPromo === 'descuento' && producto.valorDescuento > 0) {
                descuento = total * (producto.valorDescuento / 100);
                total = total - descuento;
            }

            producto.total = total;
            producto.descuento = descuento;

            if (editandoIndex >= 0) {
                productos[editandoIndex] = producto;
            } else {
                productos.push(producto);
            }

            guardarProductos();
            renderizarProductos();
            actualizarTotales();
            cerrarModalArticulo();
        }

        // Actualizar indicador de lista cargada
        function actualizarIndicadorLista() {
            const indicador = document.getElementById('indicadorListaCargada');
            const nombreDisplay = document.getElementById('nombreListaCargadaDisplay');
            
            if (listaActuallyCargada) {
                indicador.style.display = 'block';
                nombreDisplay.textContent = listaActuallyCargada.nombre;
            } else {
                indicador.style.display = 'none';
                nombreDisplay.textContent = '';
            }
        }

        // Renderizar productos
        function renderizarProductos() {
            const lista = document.getElementById('listaCompras');
            const emptyState = document.getElementById('emptyState');

            if (productos.length === 0) {
                lista.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            lista.style.display = 'flex';
            emptyState.style.display = 'none';

            // Agrupar por categor√≠a si existe
            const productosPorCategoria = {};
            const productosSinCategoria = [];
            
            productos.forEach((prod, index) => {
                const prodConIndex = { ...prod, originalIndex: index };
                if (prod.categoria && mostrarCampos.categoria) {
                    if (!productosPorCategoria[prod.categoria]) {
                        productosPorCategoria[prod.categoria] = [];
                    }
                    productosPorCategoria[prod.categoria].push(prodConIndex);
                } else {
                    productosSinCategoria.push(prodConIndex);
                }
            });

            let html = '';
            
            // Renderizar productos agrupados por categor√≠a
            Object.entries(productosPorCategoria).forEach(([categoria, items]) => {
                html += `<div class="category-group">
                    <div class="category-header">${categoriaEmojis[categoria] || 'üì¶'} ${getCategoriaTexto(categoria)}</div>`;
                items.forEach(prod => {
                    html += generarHTMLProducto(prod, prod.originalIndex);
                });
                html += `</div>`;
            });
            
            // Renderizar productos sin categor√≠a
            productosSinCategoria.forEach(prod => {
                html += generarHTMLProducto(prod, prod.originalIndex);
            });

            lista.innerHTML = html;
            
            // Inicializar drag and drop
            setTimeout(inicializarDragAndDrop, 100);
        }
        
        function generarHTMLProducto(prod, index) {
            const comprado = prod.comprado || false;
            const claseComprado = comprado ? 'item-comprado' : '';
            const trad = traducciones[idioma];
            
            return `
                <div class="item-card ${claseComprado}" draggable="true" data-index="${index}">
                    <!-- L√≠nea 1: Nombre, Precio y Checkbox -->
                    <div class="item-row-1">
                        <div class="item-name">${prod.nombre}</div>
                        <div class="item-right-1">
                            <div class="item-price">${formatearPrecio(prod.total)}</div>
                            <input type="checkbox" ${comprado ? 'checked' : ''} onchange="toggleComprado(${index})" class="checkbox-compra">
                        </div>
                    </div>
                    
                    <!-- L√≠nea 2: Unidades, Marca y Categor√≠a -->
                    <div class="item-row-2">
                        <span class="item-detail">${prod.cantidad} ${prod.unidad}</span>
                        ${mostrarCampos.marca && prod.marca ? `<span class="item-detail">${prod.marca}</span>` : ''}
                        ${mostrarCampos.categoria && prod.categoria ? `<span class="item-detail">${getCategoriaTexto(prod.categoria)}</span>` : ''}
                    </div>
                    
                    <!-- L√≠nea 3: Promoci√≥n y Nota -->
                    ${(prod.tienePromo || (mostrarCampos.nota && prod.nota)) ? `
                        <div class="item-row-3">
                            ${prod.tienePromo ? `
                                <div class="item-promo">
                                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M20 6H16V4C16 2.89 15.11 2 14 2H10C8.89 2 8 2.89 8 4V6H4C2.89 6 2.01 6.89 2.01 8L2 19C2 20.11 2.89 21 4 21H20C21.11 21 22 20.11 22 19V8C22 6.89 21.11 6 20 6ZM10 4H14V6H10V4ZM12 17L7 12H10V9H14V12H17L12 17Z" fill="currentColor"/>
                                    </svg>
                                    <span>${prod.tipoPromo === 'promocion' ? prod.descripcionPromo : prod.valorDescuento + '% OFF'}</span>
                                </div>
                            ` : ''}
                            ${mostrarCampos.nota && prod.nota ? `
                                <div class="item-nota">
                                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M14 2H6C4.9 2 4 2.9 4 4V20C4 21.1 4.89 22 5.99 22H18C19.1 22 20 21.1 20 20V8L14 2ZM16 18H8V16H16V18ZM16 14H8V12H16V14ZM13 9V3.5L18.5 9H13Z" fill="currentColor"/>
                                    </svg>
                                    <span>${prod.nota}</span>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                    
                    <!-- L√≠nea 4: Botones (Editar, Eliminar, Mover) -->
                    <div class="item-row-4">
                        <button class="item-btn-icon" onclick="event.stopPropagation(); abrirModalEditar(${index})" title="${trad.editar}" ${comprado ? 'disabled' : ''}>
                            <ion-icon name="create"></ion-icon>
                        </button>
                        <button class="item-btn-icon" onclick="event.stopPropagation(); confirmarEliminar(${index})" title="${trad.eliminar}" ${comprado ? 'disabled' : ''}>
                            <ion-icon name="trash"></ion-icon>
                        </button>
                        <button class="item-btn-icon item-btn-drag" title="Mover">
                            <ion-icon name="swap-vertical"></ion-icon>
                        </button>
                    </div>
                </div>
            `;
        }
        
        function toggleComprado(index) {
            productos[index].comprado = !productos[index].comprado;
            guardarProductos();
            renderizarProductos();
            actualizarTotales();
        }
        
        // Drag and Drop para reordenar
        let draggedElement = null;
        let draggedIndex = null;
        
        function inicializarDragAndDrop() {
            const lista = document.getElementById('listaCompras');
            if (!lista) return;
            
            // Remover listeners anteriores clonando el nodo
            const newLista = lista.cloneNode(true);
            lista.parentNode.replaceChild(newLista, lista);
            const listaActualizada = document.getElementById('listaCompras');
            
            listaActualizada.addEventListener('dragstart', function(e) {
                // Buscar el item-card m√°s cercano
                const itemCard = e.target.closest('.item-card');
                if (itemCard) {
                    draggedElement = itemCard;
                    draggedIndex = parseInt(itemCard.dataset.index);
                    itemCard.classList.add('dragging');
                    
                    // Aplicar opacidad baja a todos los dem√°s items
                    const allItems = listaActualizada.querySelectorAll('.item-card');
                    allItems.forEach(item => {
                        if (item !== itemCard) {
                            item.style.opacity = '0.3';
                        }
                    });
                    
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/html', itemCard.innerHTML);
                }
            });
            
            listaActualizada.addEventListener('dragend', function(e) {
                const itemCard = e.target.closest('.item-card');
                if (itemCard) {
                    itemCard.classList.remove('dragging');
                    
                    // Restaurar opacidad a todos los items
                    const allItems = listaActualizada.querySelectorAll('.item-card');
                    allItems.forEach(item => {
                        item.style.opacity = '';
                    });
                }
            });
            
            listaActualizada.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                
                const dragging = document.querySelector('.dragging');
                if (!dragging) return;
                
                const afterElement = getDragAfterElement(listaActualizada, e.clientY);
                
                // Solo intentar mover si afterElement es un elemento v√°lido o null
                if (!afterElement || afterElement === null) {
                    // Agregar al final
                    const lastCard = listaActualizada.querySelector('.item-card:last-child');
                    if (lastCard && lastCard !== dragging) {
                        try {
                            listaActualizada.appendChild(dragging);
                        } catch (err) {
                            console.warn('Error moving element:', err);
                        }
                    }
                } else if (afterElement && afterElement !== dragging && afterElement.parentNode === listaActualizada) {
                    // Insertar antes del elemento
                    try {
                        listaActualizada.insertBefore(dragging, afterElement);
                    } catch (err) {
                        console.warn('Error moving element:', err);
                    }
                }
            });
            
            listaActualizada.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                if (draggedIndex === null) return;
                
                // Obtener todos los items cards en su orden actual en el DOM
                const allCards = [...listaActualizada.querySelectorAll('.item-card')];
                const draggedCard = allCards.find(card => parseInt(card.dataset.index) === draggedIndex);
                
                if (!draggedCard) return;
                
                // Encontrar el nuevo √≠ndice en el array de productos
                let newIndex = 0;
                for (let i = 0; i < allCards.length; i++) {
                    if (allCards[i] === draggedCard) {
                        newIndex = i;
                        break;
                    }
                }
                
                // Solo reordenar si cambi√≥ de posici√≥n
                if (draggedIndex !== newIndex) {
                    // Reordenar el array de productos
                    const [movedItem] = productos.splice(draggedIndex, 1);
                    productos.splice(newIndex, 0, movedItem);
                    
                    // Guardar
                    guardarProductos();
                }
                
                // Limpiar estado
                draggedElement = null;
                draggedIndex = null;
                
                // Renderizar
                renderizarProductos();
                actualizarTotales();
            });
        }
        
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.item-card:not(.dragging)')];
            
            if (draggableElements.length === 0) {
                return null;
            }
            
            const result = draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY, element: null });
            
            return result.element;
        }
        
        function getCategoriaTexto(categoria) {
            const opciones = {
                'lacteos': 'L√°cteos',
                'panaderia': 'Panader√≠a',
                'congelados': 'Congelados',
                'cereales': 'Cereales',
                'papeleria': 'Papeler√≠a',
                'salud': 'Salud'
            };
            return opciones[categoria] || '';
        }

        // Actualizar totales
        function actualizarTotales() {
            const subtotal = productos.reduce((sum, p) => sum + (p.total + p.descuento), 0);
            const descuentos = productos.reduce((sum, p) => sum + p.descuento, 0);
            const total = productos.reduce((sum, p) => sum + p.total, 0);

            document.getElementById('subtotalDisplay').textContent = formatearPrecio(subtotal);
            document.getElementById('descuentosDisplay').textContent = '-' + formatearPrecio(descuentos);
            document.getElementById('totalDisplay').textContent = formatearPrecio(total);
            
            // Actualizar presupuesto
            actualizarPresupuesto(total);
        }
        
        function actualizarPresupuesto(total) {
            const budgetAmount = document.getElementById('budgetAmount');
            const budgetRemaining = document.getElementById('budgetRemaining');
            
            // Calcular total gastado (solo art√≠culos comprados)
            const totalGastado = productos
                .filter(p => p.comprado)
                .reduce((sum, p) => sum + p.total, 0);
            
            budgetAmount.textContent = formatearPrecio(presupuesto);
            
            if (presupuesto > 0) {
                const porcentaje = ((totalGastado / presupuesto) * 100).toFixed(0);
                
                budgetRemaining.textContent = `${formatearPrecio(totalGastado)} de ${formatearPrecio(presupuesto)} (${porcentaje}% usado)`;
                
                // Cambiar color seg√∫n el porcentaje
                budgetRemaining.classList.remove('warning', 'danger');
                if (porcentaje >= 100) {
                    budgetRemaining.classList.add('danger');
                } else if (porcentaje >= 80) {
                    budgetRemaining.classList.add('warning');
                }
                
                // Actualizar barra de progreso
                actualizarBarraProgreso(porcentaje);
            } else {
                budgetRemaining.textContent = 'Sin presupuesto establecido';
                actualizarBarraProgreso(0);
            }
            
            // Actualizar altura del footer si est√° visible
            if (document.querySelector('.bottom-fixed-container').classList.contains('visible')) {
                setTimeout(actualizarAltoBottomFixedContainer, 0);
            }
        }
        
        function actualizarBarraProgreso(porcentaje) {
            const progressFill = document.getElementById('budgetProgressFill');
            if (!progressFill) return;
            
            const porcentajeLimitado = Math.min(porcentaje, 100);
            progressFill.style.width = porcentajeLimitado + '%';
            
            // Cambiar color de la barra
            progressFill.classList.remove('low', 'medium', 'high');
            if (porcentaje >= 100) {
                progressFill.classList.add('high');
            } else if (porcentaje >= 80) {
                progressFill.classList.add('medium');
            } else {
                progressFill.classList.add('low');
            }
        }

        // Confirmar eliminar
        function confirmarEliminar(index) {
            mostrarConfirm(
                '¬øEliminar art√≠culo?',
                '¬øEst√°s seguro de que deseas eliminar este art√≠culo?',
                () => {
                    productos.splice(index, 1);
                    guardarProductos();
                    renderizarProductos();
                    actualizarTotales();
                }
            );
        }

        // Limpiar todo
        function confirmarLimpiar() {
            mostrarConfirm(
                '¬øLimpiar todo?',
                '¬øEst√°s seguro de que deseas eliminar todos los art√≠culos?',
                () => {
                    productos = [];
                    guardarProductos();
                    renderizarProductos();
                    actualizarIndicadorLista();
                    actualizarTotales();
                    
                    // Limpiar IVA
                    ivaActual = 0;
                    localStorage.removeItem('ivaActual');
                    
                    // Limpiar referencias a lista cargada o en edici√≥n
                    listaEnEdicion = null;
                    listaActuallyCargada = null;
                }
            );
        }

        // Guardar lista
        function guardarLista() {
            if (productos.length === 0) {
                mostrarAlertaModal('‚ö†Ô∏è Lista vac√≠a', 'No hay art√≠culos para guardar');
                return;
            }
            
            // Si estamos editando una lista O si cargamos una lista, mostrar opciones
            if (listaEnEdicion || listaActuallyCargada) {
                const nombreLista = listaEnEdicion ? listaEnEdicion.nombre : listaActuallyCargada.nombre;
                const idLista = listaEnEdicion ? listaEnEdicion.id : listaActuallyCargada.id;
                
                mostrarConfirm(
                    '¬øQu√© deseas hacer?',
                    `Tienes dos opciones:\n1. Actualizar la lista "${nombreLista}" con los cambios actuales\n2. Guardar como una nueva lista (mantiene la original intacta)`,
                    () => {
                        // Opci√≥n 1: Actualizar lista existente
                        const listas = JSON.parse(localStorage.getItem('listasGuardadas') || '{}');
                        const ivaGuardado = parseFloat(localStorage.getItem('ivaActual') || 0);
                        
                        listas[idLista] = {
                            nombre: nombreLista,
                            fecha: new Date().toISOString(),
                            productos: productos,
                            total: productos.reduce((sum, p) => sum + p.total, 0),
                            iva: ivaGuardado,
                            presupuesto: presupuesto
                        };
                        
                        localStorage.setItem('listasGuardadas', JSON.stringify(listas));
                        
                        // Guardar que esta lista sigue cargada
                        localStorage.setItem('listaActuallyCargada', JSON.stringify(listaActuallyCargada || listaEnEdicion));
                        
                        // Limpiar solo listaEnEdicion (no listaActuallyCargada porque sigue siendo la lista cargada)
                        listaEnEdicion = null;
                        
                        mostrarAlertaModal('‚úÖ Actualizaci√≥n completada', `Lista "${nombreLista}" actualizada exitosamente`, () => {
                            renderizarListasGuardadas();
                            actualizarIndicadorLista();
                        });
                    },
                    () => {
                        // Opci√≥n 2: Guardar como nueva lista
                        listaEnEdicion = null;
                        // NO limpiar listaActuallyCargada aqu√≠, se limpiar√° en confirmarGuardarLista si se confirma
                        // Si se cancela el modal, la lista sigue siendo la cargada
                        document.getElementById('modalGuardar').classList.add('active');
                        document.body.classList.add('no-scroll');
                        document.getElementById('nombreLista').focus();
                        document.getElementById('mensajeErrorNombre').style.display = 'none';
                        document.getElementById('btnGuardarLista').style.display = 'inline-block';
                        document.getElementById('btnSobrescribir').style.display = 'none';
                        window.listaDuplicada = null;
                    },
                    'Actualizar', 
                    'Guardar como nueva'
                );
            } else {
                // Comportamiento normal si no estamos editando ni cargando lista
                document.getElementById('modalGuardar').classList.add('active');
                document.body.classList.add('no-scroll');
                document.getElementById('nombreLista').focus();
                // Limpiar estado
                document.getElementById('mensajeErrorNombre').style.display = 'none';
                document.getElementById('btnGuardarLista').style.display = 'inline-block';
                document.getElementById('btnSobrescribir').style.display = 'none';
                window.listaDuplicada = null;
            }
        }

        function cerrarModalGuardar() {
            document.getElementById('modalGuardar').classList.remove('active');
            document.body.classList.remove('no-scroll');
            document.getElementById('nombreLista').value = '';
            document.getElementById('mensajeErrorNombre').style.display = 'none';
            document.getElementById('btnGuardarLista').style.display = 'inline-block';
            document.getElementById('btnSobrescribir').style.display = 'none';
            window.listaDuplicada = null;
        }

        // Verificar en tiempo real si el nombre ya existe
        function verificarNombreLista() {
            const nombreLista = document.getElementById('nombreLista').value.trim();
            const mensajeError = document.getElementById('mensajeErrorNombre');
            const btnGuardar = document.getElementById('btnGuardarLista');
            const btnSobrescribir = document.getElementById('btnSobrescribir');
            
            if (!nombreLista) {
                mensajeError.style.display = 'none';
                btnGuardar.style.display = 'inline-block';
                btnSobrescribir.style.display = 'none';
                window.listaDuplicada = null;
                return;
            }
            
            const listas = JSON.parse(localStorage.getItem('listasGuardadas') || '{}');
            
            // Buscar si existe una lista con ese nombre
            const listaExistente = Object.entries(listas).find(([id, lista]) => 
                lista.nombre.toLowerCase() === nombreLista.toLowerCase()
            );
            
            if (listaExistente) {
                // Mostrar error y bot√≥n de sobrescribir
                mensajeError.style.display = 'block';
                btnGuardar.style.display = 'none';
                btnSobrescribir.style.display = 'inline-block';
                window.listaDuplicada = listaExistente[0]; // Guardar el ID
            } else {
                // Ocultar error y mostrar bot√≥n normal
                mensajeError.style.display = 'none';
                btnGuardar.style.display = 'inline-block';
                btnSobrescribir.style.display = 'none';
                window.listaDuplicada = null;
            }
        }

        function confirmarGuardarLista() {
            const nombreLista = document.getElementById('nombreLista').value.trim();
            
            if (!nombreLista) {
                mostrarAlertaModal('‚ö†Ô∏è Campo requerido', 'El nombre de la lista es obligatorio');
                return;
            }

            const listas = JSON.parse(localStorage.getItem('listasGuardadas') || '{}');
            
            // Validar l√≠mite de 10 listas
            const listasArray = Object.entries(listas);
            if (listasArray.length >= 10) {
                mostrarAlertaModal('‚ùå L√≠mite alcanzado', 'Solo puedes guardar un m√°ximo de 10 listas. Debes eliminar una de las listas guardadas para poder guardar una nueva.\n\nüí° Tus datos en "Mis Gastos" se mantendr√°n aunque elimines una lista.');
                return;
            }
            
            const id = Date.now().toString();
            
            // Obtener IVA actual si existe
            const ivaGuardado = parseFloat(localStorage.getItem('ivaActual') || 0);
            
            listas[id] = {
                nombre: nombreLista,
                fecha: new Date().toISOString(),
                productos: productos,
                total: productos.reduce((sum, p) => sum + p.total, 0),
                iva: ivaGuardado, // Incluir IVA en la lista
                presupuesto: presupuesto // Incluir presupuesto en la lista
            };

            localStorage.setItem('listasGuardadas', JSON.stringify(listas));
            
            // Limpiar referencias a lista cargada o en edici√≥n (porque es una nueva lista)
            listaEnEdicion = null;
            listaActuallyCargada = null;
            localStorage.removeItem('listaActuallyCargada');
            
            cerrarModalGuardar();
            mostrarAlertaModal('‚úÖ √âxito', 'Lista guardada exitosamente', () => {
                renderizarListasGuardadas();
                actualizarIndicadorLista();
            });
        }
        
        // Variable global para rastrear si estamos editando una lista
        let listaEnEdicion = null;
        // Variable para rastrear si se carg√≥ una lista (sin intenci√≥n de editar)
        let listaActuallyCargada = null;
        
        // Funci√≥n para editar una lista existente
        function editarLista(id) {
            const listas = JSON.parse(localStorage.getItem('listasGuardadas') || '{}');
            const lista = listas[id];
            
            if (lista) {
                // Cargar la lista
                productos = [...lista.productos];
                guardarProductos();
                
                // Cargar presupuesto
                if (lista.presupuesto && lista.presupuesto > 0) {
                    presupuesto = lista.presupuesto;
                    localStorage.setItem('presupuesto', presupuesto);
                } else {
                    presupuesto = 0;
                    localStorage.removeItem('presupuesto');
                }
                
                // Cargar IVA
                if (lista.iva && lista.iva > 0) {
                    ivaActual = lista.iva;
                    localStorage.setItem('ivaActual', ivaActual);
                } else {
                    ivaActual = 0;
                    localStorage.removeItem('ivaActual');
                }
                
                // Guardar que estamos editando esta lista
                listaEnEdicion = {
                    id: id,
                    nombre: lista.nombre
                };
                
                renderizarProductos();
                actualizarTotales();
                actualizarEstadoPresupuesto();
                
                // Actualizar presupuesto visualmente
                const totalGastado = productos
                    .filter(p => p.comprado)
                    .reduce((sum, p) => sum + p.total, 0);
                actualizarPresupuesto(totalGastado);
                
                // Cambiar a la secci√≥n de inicio
                document.querySelectorAll('.content-section').forEach(section => {
                    section.classList.remove('active');
                });
                document.getElementById('seccionInicio').classList.add('active');
                
                // Mostrar el contenedor fijo del fondo
                document.querySelector('.bottom-fixed-container').classList.add('visible');
                
                // Actualizar men√∫ activo
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelector('.menu-item').classList.add('active');
                
                // Mostrar notificaci√≥n de que se est√° editando
                mostrarAlertaModal('<ion-icon name="newspaper" style="margin-right: 6px; vertical-align: middle;"></ion-icon>Editando', `Editando: "${lista.nombre}"\n\nCuando guardes, podr√°s elegir si actualizar esta lista o guardar como nueva.`, null, 'COMPRENDO');
            }
        }
        function sobrescribirLista() {
            const nombreLista = document.getElementById('nombreLista').value.trim();
            const idDuplicada = window.listaDuplicada;
            
            if (!nombreLista || !idDuplicada) {
                mostrarAlertaModal('‚ùå Error', 'Error al sobrescribir la lista');
                return;
            }
            
            const listas = JSON.parse(localStorage.getItem('listasGuardadas') || '{}');
            
            // Obtener IVA actual si existe
            const ivaGuardado = parseFloat(localStorage.getItem('ivaActual') || 0);
            
            // Actualizar la lista existente con los datos nuevos
            listas[idDuplicada] = {
                nombre: nombreLista,
                fecha: new Date().toISOString(),
                productos: productos,
                total: productos.reduce((sum, p) => sum + p.total, 0),
                iva: ivaGuardado, // Incluir IVA en la lista
                presupuesto: presupuesto // Incluir presupuesto en la lista
            };

            localStorage.setItem('listasGuardadas', JSON.stringify(listas));
            cerrarModalGuardar();
            mostrarAlertaModal('‚úÖ √âxito', 'Lista sobrescrita exitosamente', () => {
                renderizarListasGuardadas();
            });
        }
        
        // Presupuesto
        function abrirModalPresupuesto() {
            const titulo = document.getElementById('modalPresupuestoTitle');
            const svg = titulo.querySelector('svg');
            
            document.getElementById('inputPresupuesto').value = presupuesto > 0 ? formatearNumero(presupuesto) : '';
            
            // Cambiar t√≠tulo seg√∫n si hay presupuesto o no
            if (presupuesto > 0) {
                titulo.innerHTML = `<ion-icon name="wallet" style="margin-right: 6px;"></ion-icon>Editar Presupuesto`;
            } else {
                titulo.innerHTML = `<ion-icon name="wallet" style="margin-right: 6px;"></ion-icon>Agregar Presupuesto`;
            }
            
            document.getElementById('modalPresupuesto').classList.add('active');
            document.body.classList.add('no-scroll');
        }
        
        function cerrarModalPresupuesto() {
            document.getElementById('modalPresupuesto').classList.remove('active');
            document.body.classList.remove('no-scroll');
        }
        
        /* ============================================================
           FUNCIONES: Modal Agregar IVA - OPCI√ìN 4
           Fase 1: Calcular con IVA
           Fase 2: Confirmaci√≥n de pago
           ============================================================ */
        function abrirModalAgregarIVA() {
            document.getElementById('inputIVAModalTotal').value = '';
            document.getElementById('totalConIVADisplay').style.display = 'none';
            document.getElementById('modalAgregarIVA').classList.add('active');
            document.body.classList.add('no-scroll');
            document.getElementById('inputIVAModalTotal').focus();
        }
        
        function cerrarModalAgregarIVA() {
            document.getElementById('modalAgregarIVA').classList.remove('active');
            document.body.classList.remove('no-scroll');
        }
        
        function actualizarEstadoBotonesIVA() {
            const inputIVA = document.getElementById('inputIVAModalTotal');
            const valorIVA = limpiarNumero(inputIVA.value);
            const btnGuardarLista = document.getElementById('btnGuardarListaConIVA');
            const totalConIVADisplay = document.getElementById('totalConIVADisplay');
            const totalConIVAValor = document.getElementById('totalConIVAValor');
            
            if (valorIVA > 0) {
                // Mostrar el total con IVA
                const subtotal = productos.reduce((sum, p) => sum + p.total, 0);
                const totalConIVA = subtotal + valorIVA;
                
                totalConIVADisplay.style.display = 'block';
                totalConIVAValor.textContent = formatearPrecio(totalConIVA);
                
                // Habilitar bot√≥n
                btnGuardarLista.disabled = false;
                btnGuardarLista.style.opacity = '1';
                btnGuardarLista.style.cursor = 'pointer';
            } else {
                totalConIVADisplay.style.display = 'none';
                btnGuardarLista.disabled = true;
                btnGuardarLista.style.opacity = '0.5';
                btnGuardarLista.style.cursor = 'not-allowed';
            }
        }
        
        // FASE 1: Solo visualizar o guardar lista con IVA
        function confirmarAgregarIVA() {
            const inputIVA = document.getElementById('inputIVAModalTotal');
            const valorIVA = limpiarNumero(inputIVA.value);
            
            if (valorIVA <= 0) {
                mostrarAlerta('Por favor ingresa un valor v√°lido para el IVA');
                return;
            }
            
            // Guardar el IVA para visualizaci√≥n
            ivaActual = valorIVA;
            localStorage.setItem('ivaActual', ivaActual);
            
            // Mostrar confirmaci√≥n
            mostrarAlerta('‚úì Lista guardada. Subtotal + IVA visible en el resumen');
            
            cerrarModalAgregarIVA();
        }
        
        // FASE 2: Abrir modal de confirmaci√≥n de pago
        function abrirConfirmacionPagoIVA() {
            const inputIVA = document.getElementById('inputIVAModalTotal');
            const valorIVA = limpiarNumero(inputIVA.value);
            
            if (valorIVA <= 0) {
                mostrarAlerta('Por favor ingresa un valor v√°lido para el IVA');
                return;
            }
            
            // Calcular valores para mostrar
            const subtotal = productos.reduce((sum, p) => sum + p.total, 0);
            const totalConIVA = subtotal + valorIVA;
            
            // Llenar datos en el modal de confirmaci√≥n
            document.getElementById('ivaConfirmSubtotal').textContent = formatearPrecio(subtotal);
            document.getElementById('ivaConfirmIVA').textContent = formatearPrecio(valorIVA);
            document.getElementById('ivaConfirmTotal').textContent = formatearPrecio(totalConIVA);
            
            // Fecha formateada
            const hoy = new Date().toLocaleDateString('es-CO', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            document.getElementById('ivaConfirmFecha').textContent = hoy;
            
            // Guardar el valor de IVA en variable temporal
            window.ivaConfirmValue = valorIVA;
            window.ivaConfirmSubtotal = subtotal;
            
            // IMPORTANTE: Cerrar el primer modal ANTES de abrir el segundo
            // Esto asegura que solo haya UN popup activo a la vez
            document.getElementById('modalAgregarIVA').classList.remove('active');
            
            // Abrir modal de confirmaci√≥n
            document.getElementById('modalConfirmacionPagoIVA').classList.add('active');
            document.body.classList.add('no-scroll');
        }
        
        function cerrarConfirmacionPagoIVA() {
            document.getElementById('modalConfirmacionPagoIVA').classList.remove('active');
            document.body.classList.remove('no-scroll');
        }
        
        // FASE 3: Confirmar que S√ç pag√≥ el IVA y registrar
        function confirmarPagoIVA() {
            const valorIVA = window.ivaConfirmValue;
            const subtotal = window.ivaConfirmSubtotal;
            
            // Guardar en localStorage para visualizaci√≥n
            ivaActual = valorIVA;
            localStorage.setItem('ivaActual', ivaActual);
            
            // Registrar en historial de IVA
            let historialIVA = JSON.parse(localStorage.getItem('historialIVA') || '[]');
            
            const listas = JSON.parse(localStorage.getItem('listasGuardadas') || '{}');
            const listaActual = Object.keys(listas).length > 0 ? 
                Object.values(listas)[Object.keys(listas).length - 1] : null;
            
            const nombreLista = listaActual ? listaActual.nombre : 'Compra sin lista';
            const totalConIVA = subtotal + valorIVA;
            
            // Agregar nuevo registro
            const nuevoRegistro = {
                id: Date.now(),
                fecha: new Date().toISOString(),
                nombreLista: nombreLista,
                ivaTotal: valorIVA,
                totalProductos: subtotal,
                totalConIVA: totalConIVA
            };
            
            historialIVA.push(nuevoRegistro);
            localStorage.setItem('historialIVA', JSON.stringify(historialIVA));
            
            // Mostrar confirmaci√≥n (sin alerta que interrumpe)
            // mostrarAlerta('‚úì IVA registrado en tu historial: $' + formatearPrecio(valorIVA));
            
            // Cerrar ambos modales
            cerrarConfirmacionPagoIVA();
            cerrarModalAgregarIVA();
            
            // Actualizar tab de IVA
            renderizarIVA();
            
            // Abrir modal de guardar lista
            setTimeout(() => {
                guardarLista();
            }, 300);
        }
        
        function mostrarAlerta(mensaje) {
            alert(mensaje);
        }
        
        function confirmarPresupuesto() {
            const valor = limpiarNumero(document.getElementById('inputPresupuesto').value);
            presupuesto = valor;
            localStorage.setItem('presupuesto', presupuesto);
            actualizarPresupuesto(productos.reduce((sum, p) => sum + p.total, 0));
            actualizarEstadoPresupuesto();
            cerrarModalPresupuesto();
        }
        
        /* ============================================================
           FUNCI√ìN: Confirmar eliminaci√≥n de presupuesto
           Muestra un di√°logo de confirmaci√≥n antes de borrar
           ============================================================ */
        function confirmarBorrarPresupuesto() {
            mostrarConfirm(
                '¬øBorrar presupuesto?',
                '¬øEst√°s seguro de que deseas eliminar el presupuesto establecido?',
                borrarPresupuesto
            );
        }
        
        /* ============================================================
           FUNCI√ìN: Borrar presupuesto
           Elimina el presupuesto y actualiza el estado visual
           ============================================================ */
        function borrarPresupuesto() {
            presupuesto = 0;
            localStorage.setItem('presupuesto', presupuesto);
            actualizarPresupuesto(productos.reduce((sum, p) => sum + p.total, 0));
            actualizarEstadoPresupuesto();
        }
        
        /* ============================================================
           FUNCI√ìN: Controla la visibilidad del budget-card
           Muestra "Sin presupuesto establecido" o "Presupuesto disponible"
           seg√∫n si hay presupuesto establecido o no
           ============================================================ */
        function actualizarEstadoPresupuesto() {
            const budgetCardEmpty = document.getElementById('budgetCardEmpty');
            const budgetCardFull = document.getElementById('budgetCardFull');
            
            if (presupuesto > 0) {
                // Mostrar presupuesto completo
                budgetCardEmpty.style.display = 'none';
                budgetCardFull.style.display = 'block';
            } else {
                // Mostrar "Sin presupuesto establecido"
                budgetCardEmpty.style.display = 'block';
                budgetCardFull.style.display = 'none';
            }
        }

        /* ============================================================
           FUNCI√ìN: Abrir modal para guardar presupuesto
           Muestra confirmaci√≥n con los datos del presupuesto actual
           ============================================================ */
        function abrirModalGuardarPresupuesto() {
            if (presupuesto <= 0) {
                mostrarAlertaModal('‚ö†Ô∏è Presupuesto requerido', 'No hay presupuesto establecido para guardar.');
                return;
            }

            // Actualizar datos del modal
            const gastoActual = productos.reduce((sum, p) => sum + p.total, 0);
            const disponible = presupuesto - gastoActual;
            
            document.getElementById('presuGuardarMonto').textContent = '$' + presupuesto.toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('gastoGuardarMonto').textContent = '$' + gastoActual.toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            
            // Cambiar color del disponible seg√∫n si hay disponible o no
            const disponibleElement = document.getElementById('disponibleGuardarMonto');
            if (disponible >= 0) {
                disponibleElement.textContent = '$' + disponible.toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                disponibleElement.style.color = 'var(--primary-color)';
            } else {
                disponibleElement.textContent = '-$' + Math.abs(disponible).toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                disponibleElement.style.color = '#ff3232';
            }
            
            document.getElementById('productosGuardarCantidad').textContent = productos.length;
            
            // Abrir modal
            document.getElementById('modalGuardarPresupuesto').classList.add('active');
        }

        function cerrarModalGuardarPresupuesto() {
            document.getElementById('modalGuardarPresupuesto').classList.remove('active');
        }

        /* ============================================================
           FUNCI√ìN: Confirmar guardar presupuesto
           Guarda presupuesto, gasto real y disponible (SIN IVA)
           ============================================================ */
        function confirmarGuardarPresupuesto() {
            const gastoActual = productos.reduce((sum, p) => sum + p.total, 0);
            const presupuestos = JSON.parse(localStorage.getItem('presupuestosGuardados') || '[]');
            
            // Validar l√≠mite de 10 presupuestos
            if (presupuestos.length >= 10) {
                mostrarConfirm(
                    'L√≠mite de presupuestos alcanzado',
                    'Solo puedes guardar un m√°ximo de 10 presupuestos. Debes eliminar uno antes de guardar uno nuevo.',
                    null,
                    () => {
                        cerrarModalGuardarPresupuesto();
                    }
                );
                return;
            }
            
            // Crear objeto del presupuesto
            const presupuestoGuardado = {
                id: Date.now(),
                presupuesto: presupuesto,
                gastoReal: gastoActual,
                disponible: presupuesto - gastoActual,
                fecha: new Date().toLocaleDateString('es-ES', { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                }),
                cantidadProductos: productos.length
            };

            // Agregar a la lista
            presupuestos.push(presupuestoGuardado);

            // Guardar en localStorage
            localStorage.setItem('presupuestosGuardados', JSON.stringify(presupuestos));

            // Cerrar modal
            cerrarModalGuardarPresupuesto();
            
            // Mostrar confirmaci√≥n
            mostrarAlertaModal('‚úÖ Presupuesto guardado', 'Se registr√≥ en la pesta√±a "Presupuesto" de "Mis Gastos"');
        }

        // Listas guardadas
        function renderizarListasGuardadas() {
            const container = document.getElementById('listasGuardadas');
            const listas = JSON.parse(localStorage.getItem('listasGuardadas') || '{}');
            const listasArray = Object.entries(listas);

            if (listasArray.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <svg style="width: 64px; height: 64px; opacity: 0.5;" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M9 5H7C6.46957 5 5.96086 5.21071 5.58579 5.58579C5.21071 5.96086 5 6.46957 5 7V19C5 19.5304 5.21071 20.0391 5.58579 20.4142C5.96086 20.7893 6.46957 21 7 21H17C17.5304 21 18.0391 20.7893 18.4142 20.4142C18.7893 20.0391 19 19.5304 19 19V7C19 6.46957 18.7893 5.96086 18.4142 5.58579C18.0391 5.21071 17.5304 5 17 5H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M9 5C9 4.46957 9.21071 3.96086 9.58579 3.58579C9.96086 3.21071 10.4696 3 11 3H13C13.5304 3 14.0391 3.21071 14.4142 3.58579C14.7893 3.96086 15 4.46957 15 5C15 5.53043 14.7893 6.03914 14.4142 6.41421C14.0391 6.78929 13.5304 7 13 7H11C10.4696 7 9.96086 6.78929 9.58579 6.41421C9.21071 6.03914 9 5.53043 9 5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <div class="empty-state-text">No hay listas guardadas</div>
                    </div>
                `;
                return;
            }

            // Encabezado con checkbox "Seleccionar todo" y bot√≥n de eliminar seleccionadas
            const headerHTML = `
                <div style="display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--bg-card); border-bottom: 1px solid var(--border-color); border-radius: 12px 12px 0 0; margin-bottom: 12px;">
                    <input type="checkbox" id="selectAllListas" onchange="seleccionarTodasLas()" style="width: 18px; height: 18px; cursor: pointer;">
                    <label for="selectAllListas" style="flex: 1; cursor: pointer; font-weight: 500; color: var(--text-primary);">Seleccionar todas</label>
                    <button class="btn btn-delete" id="btnEliminarSeleccionadas" style="display: none;" onclick="eliminarSeleccionadas()">
                        <svg style="width: 14px; height: 14px; display: inline-block; vertical-align: middle; margin-right: 4px;" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M3 6H5H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Eliminar seleccionadas
                    </button>
                </div>
            `;

            const listasHTML = listasArray.map(([id, lista]) => `
                <div class="saved-list-card" style="display: flex; gap: 12px; align-items: flex-start;">
                    <input type="checkbox" class="checkbox-lista" data-id="${id}" onchange="actualizarBtnEliminarSeleccionadas()" style="width: 18px; height: 18px; cursor: pointer; margin-top: 12px; flex-shrink: 0;">
                    <div style="flex: 1;">
                        <div class="saved-list-header">
                            <div>
                                <div class="saved-list-name">${lista.nombre}</div>
                                <div class="saved-list-date">${new Date(lista.fecha).toLocaleDateString()}</div>
                                <!-- Indicador de IVA si la lista tiene IVA -->
                                ${lista.iva && lista.iva > 0 ? `<div class="iva-indicator">‚úì Esta lista tiene IVA (${formatearPrecio(lista.iva)})</div>` : ''}
                            </div>
                        </div>
                        <div class="saved-list-info">
                            <span>${lista.productos.length} art√≠culos</span>
                            <span>‚Ä¢</span>
                            <span>${formatearPrecio(lista.total)}</span>
                        </div>
                        <div class="saved-list-actions">
                            <button class="btn btn-primary" onclick="cargarLista('${id}')">
                                <ion-icon name="download" style="margin-right: 4px;"></ion-icon>
                                Cargar
                            </button>
                            <button class="btn btn-delete" onclick="eliminarLista('${id}')">
                                <ion-icon name="trash" style="margin-right: 4px;"></ion-icon>
                                Eliminar
                            </button>
                            <button class="btn btn-secondary" onclick="generarResumenLista('${id}')">
                                <ion-icon name="document" style="margin-right: 4px;"></ion-icon>
                                Resumen
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = headerHTML + listasHTML;
        }

        function cargarLista(id) {
            mostrarConfirm(
                '¬øCargar lista?',
                '¬øEst√°s seguro de que deseas cargar esta lista? Se reemplazar√° la lista actual.',
                () => {
                    listaEnEdicion = null; // Limpiar estado de edici√≥n
                    const listas = JSON.parse(localStorage.getItem('listasGuardadas') || '{}');
                    const lista = listas[id];
                    
                    if (lista) {
                        // Guardar que cargamos una lista
                        listaActuallyCargada = {
                            id: id,
                            nombre: lista.nombre
                        };
                        
                        // Guardar en localStorage para persistencia
                        localStorage.setItem('listaActuallyCargada', JSON.stringify(listaActuallyCargada));
                        
                        productos = [...lista.productos];
                        guardarProductos();
                        
                        // IMPORTANTE: Cargar presupuesto ANTES de actualizar totales
                        if (lista.presupuesto && lista.presupuesto > 0) {
                            presupuesto = lista.presupuesto;
                            localStorage.setItem('presupuesto', presupuesto);
                        } else {
                            presupuesto = 0;
                            localStorage.removeItem('presupuesto');
                        }
                        
                        renderizarProductos();
                        actualizarIndicadorLista();
                        actualizarTotales();
                        actualizarEstadoPresupuesto();
                        
                        // Actualizar presupuesto visualmente con el valor correcto
                        const totalGastado = productos
                            .filter(p => p.comprado)
                            .reduce((sum, p) => sum + p.total, 0);
                        actualizarPresupuesto(totalGastado);
                        
                        // Limpiar IVA al cargar una nueva lista
                        ivaActual = 0;
                        localStorage.removeItem('ivaActual');
                        
                        // Cambiar a la secci√≥n de inicio
                        document.querySelectorAll('.content-section').forEach(section => {
                            section.classList.remove('active');
                        });
                        document.getElementById('seccionInicio').classList.add('active');
                        
                        // Mostrar el contenedor fijo del fondo
                        document.querySelector('.bottom-fixed-container').classList.add('visible');
                        
                        // Actualizar men√∫ activo
                        document.querySelectorAll('.menu-item').forEach(item => {
                            item.classList.remove('active');
                        });
                        document.querySelector('.menu-item').classList.add('active');
                    }
                }
            );
        }

        function eliminarLista(id) {
            mostrarConfirm(
                '¬øEliminar lista?',
                '¬øEst√°s seguro de que deseas eliminar esta lista?',
                () => {
                    const listas = JSON.parse(localStorage.getItem('listasGuardadas') || '{}');
                    delete listas[id];
                    localStorage.setItem('listasGuardadas', JSON.stringify(listas));
                    renderizarListasGuardadas();
                }
            );
        }
        
        // Funci√≥n para seleccionar/deseleccionar todas las listas
        function seleccionarTodasLas() {
            const checkboxSelectAll = document.getElementById('selectAllListas');
            const checkboxesListas = document.querySelectorAll('.checkbox-lista');
            
            checkboxesListas.forEach(checkbox => {
                checkbox.checked = checkboxSelectAll.checked;
            });
            
            actualizarBtnEliminarSeleccionadas();
        }
        
        // Funci√≥n para actualizar visibilidad del bot√≥n de eliminar seleccionadas
        function actualizarBtnEliminarSeleccionadas() {
            const checkboxesListas = document.querySelectorAll('.checkbox-lista');
            const btnEliminarSeleccionadas = document.getElementById('btnEliminarSeleccionadas');
            const checkboxSelectAll = document.getElementById('selectAllListas');
            
            // Contar cu√°ntas est√°n seleccionadas
            const seleccionadas = Array.from(checkboxesListas).filter(cb => cb.checked).length;
            
            // Mostrar bot√≥n si hay al menos una seleccionada
            if (seleccionadas > 0) {
                btnEliminarSeleccionadas.style.display = 'inline-flex';
            } else {
                btnEliminarSeleccionadas.style.display = 'none';
            }
            
            // Actualizar estado del checkbox "Seleccionar todo"
            checkboxSelectAll.checked = seleccionadas === checkboxesListas.length && checkboxesListas.length > 0;
        }
        
        // Funci√≥n para eliminar todas las listas seleccionadas
        function eliminarSeleccionadas() {
            const checkboxesListas = document.querySelectorAll('.checkbox-lista:checked');
            const idsAEliminar = Array.from(checkboxesListas).map(cb => cb.dataset.id);
            
            if (idsAEliminar.length === 0) {
                mostrarAlertaModal('‚ö†Ô∏è Selecciona listas', 'No hay listas seleccionadas');
                return;
            }
            
            const mensaje = idsAEliminar.length === 1 
                ? '¬øEst√°s seguro de que deseas eliminar esta lista?'
                : `¬øEst√°s seguro de que deseas eliminar ${idsAEliminar.length} listas?`;
            
            mostrarConfirm(
                '¬øEliminar listas?',
                mensaje,
                () => {
                    const listas = JSON.parse(localStorage.getItem('listasGuardadas') || '{}');
                    
                    // Eliminar todas las listas seleccionadas
                    idsAEliminar.forEach(id => {
                        delete listas[id];
                    });
                    
                    localStorage.setItem('listasGuardadas', JSON.stringify(listas));
                    renderizarListasGuardadas();
                }
            );
        }
        
        // Generar resumen de lista
        function generarResumenLista(id) {
            const listas = JSON.parse(localStorage.getItem('listasGuardadas') || '{}');
            const lista = listas[id];
            
            if (!lista) return;
            
            // Calcular totales
            const subtotal = lista.productos.reduce((sum, p) => sum + (p.total + p.descuento), 0);
            const descuentos = lista.productos.reduce((sum, p) => sum + p.descuento, 0);
            const total = lista.productos.reduce((sum, p) => sum + p.total, 0);
            
            // T√≠tulo y fecha
            document.getElementById('resumenTitulo').textContent = lista.nombre;
            document.getElementById('resumenFecha').textContent = new Date(lista.fecha).toLocaleDateString('es-ES', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            // Items
            const itemsHTML = lista.productos.map(prod => `
                <div class="resumen-item">
                    <div class="resumen-item-info">
                        <div class="resumen-item-name">${prod.nombre}</div>
                        <div class="resumen-item-details">
                            ${prod.marca ? prod.marca + ' ‚Ä¢ ' : ''}${prod.cantidad} ${prod.unidad}
                            ${prod.tienePromo ? ' ‚Ä¢ ' + (prod.tipoPromo === 'promocion' ? prod.descripcionPromo : prod.valorDescuento + '% OFF') : ''}
                        </div>
                    </div>
                    <div class="resumen-item-price">${formatearPrecio(prod.total)}</div>
                </div>
            `).join('');
            
            document.getElementById('resumenItems').innerHTML = itemsHTML;
            
            // Summary
            const ivaGuardado = parseFloat(localStorage.getItem('ivaActual') || 0);
            const totalConIVA = ivaGuardado > 0 ? total + ivaGuardado : total;
            
            const summaryHTML = `
                ${presupuesto > 0 ? `
                    <div class="resumen-summary-row budget">
                        <span>Presupuesto:</span>
                        <span>${formatearPrecio(presupuesto)}</span>
                    </div>
                ` : ''}
                <div class="resumen-summary-row">
                    <span>Subtotal:</span>
                    <span>${formatearPrecio(subtotal)}</span>
                </div>
                <div class="resumen-summary-row">
                    <span>Descuentos:</span>
                    <span>-${formatearPrecio(descuentos)}</span>
                </div>
                ${ivaGuardado > 0 ? `
                    <div class="resumen-summary-row">
                        <span>IVA:</span>
                        <span>+${formatearPrecio(ivaGuardado)}</span>
                    </div>
                ` : ''}
                <div class="resumen-summary-row total">
                    <span>${ivaGuardado > 0 ? 'Total con IVA:' : 'Total:'}</span>
                    <span>${formatearPrecio(totalConIVA)}</span>
                </div>
            `;
            
            document.getElementById('resumenSummary').innerHTML = summaryHTML;
            
            // Mostrar modal
            document.getElementById('modalResumen').classList.add('active');
            document.body.classList.add('no-scroll');
        }
        
        function cerrarResumen() {
            document.getElementById('modalResumen').classList.remove('active');
            document.body.classList.remove('no-scroll');
        }
        
        function descargarResumen() {
            // Obtener datos
            const titulo = document.getElementById('resumenTitulo').textContent;
            const fecha = document.getElementById('resumenFecha').textContent;
            const itemsHTML = document.getElementById('resumenItems').innerHTML;
            const summaryHTML = document.getElementById('resumenSummary').innerHTML;
            
            // Crear PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            // Colores
            const colorPrimario = '#39ff14';
            const colorTexto = '#000000';
            const colorFondo = '#f5f5f5';
            
            let yPosition = 20;
            const pageHeight = doc.internal.pageSize.height;
            const pageWidth = doc.internal.pageSize.width;
            const margen = 15;
            const anchoUtil = pageWidth - (2 * margen);
            
            // T√≠tulo
            doc.setFontSize(18);
            doc.setTextColor(0, 0, 0); // Negro
            doc.text(titulo, pageWidth / 2, yPosition, { align: 'center' });
            
            // Fecha
            yPosition += 10;
            doc.setFontSize(10);
            doc.setTextColor(128, 128, 128);
            doc.text(fecha, pageWidth / 2, yPosition, { align: 'center' });
            
            // L√≠nea divisoria
            yPosition += 8;
            doc.setDrawColor(57, 255, 20);
            doc.line(margen, yPosition, pageWidth - margen, yPosition);
            
            // T√≠tulos de columnas
            yPosition += 10;
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'bold');
            
            const colAncho = anchoUtil / 3;
            doc.text('Producto', margen + 5, yPosition);
            doc.text('Cantidad', pageWidth - margen - 30, yPosition, { align: 'right' });
            doc.text('Precio', pageWidth - margen - 5, yPosition, { align: 'right' });
            
            // L√≠nea bajo encabezado
            yPosition += 2;
            doc.setDrawColor(200, 200, 200);
            doc.line(margen, yPosition, pageWidth - margen, yPosition);
            
            // Agregar √≠tems
            yPosition += 8;
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            
            // Procesar items del HTML
            const itemsContainer = document.querySelector('#resumenItems');
            const items = itemsContainer.querySelectorAll('.resumen-item');
            
            items.forEach((item, index) => {
                // Verificar si necesitamos una nueva p√°gina
                if (yPosition > pageHeight - 50) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                const nombre = item.querySelector('.resumen-item-name')?.textContent || 'Sin nombre';
                const cantidad = item.querySelector('.resumen-item-details')?.textContent || '';
                const precio = item.querySelector('.resumen-item-price')?.textContent || '$0';
                
                // Mostrar nombre en negrita
                doc.setFont(undefined, 'bold');
                doc.text(nombre.substring(0, 30), margen + 5, yPosition);
                
                // Mostrar cantidad y precio en normal, alineados a la derecha
                doc.setFont(undefined, 'normal');
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.text(cantidad, pageWidth - margen - 30, yPosition + 3, { align: 'right' });
                doc.text(precio, pageWidth - margen - 5, yPosition + 3, { align: 'right' });
                
                yPosition += 7;
                doc.setFontSize(9);
                doc.setTextColor(0, 0, 0);
            });
            
            // L√≠nea divisoria antes de resumen
            yPosition += 5;
            doc.setDrawColor(200, 200, 200);
            doc.line(margen, yPosition, pageWidth - margen, yPosition);
            
            // Resumen (Subtotal, Descuentos, Total)
            yPosition += 8;
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            
            // Obtener valores del resumen
            const summaryContainer = document.querySelector('#resumenSummary');
            const rows = summaryContainer.querySelectorAll('.resumen-summary-row');
            
            rows.forEach((row, index) => {
                const isTotal = row.classList.contains('total');
                const cells = row.querySelectorAll('span');
                const label = cells[0]?.textContent || '';
                const value = cells[1]?.textContent || '';
                
                if (isTotal) {
                    doc.setFont(undefined, 'bold');
                    doc.setFontSize(12);
                    doc.setTextColor(57, 255, 20); // Verde caracter√≠stico
                    // Rect√°ngulo de fondo NEGRO para total
                    doc.setFillColor(0, 0, 0); // Negro
                    doc.rect(margen, yPosition - 5, anchoUtil, 8, 'F');
                } else {
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(10);
                    doc.setTextColor(0, 0, 0);
                }
                
                doc.text(label, margen + 5, yPosition);
                doc.text(value, pageWidth - margen - 5, yPosition, { align: 'right' });
                yPosition += 7;
            });
            
            // Pie de p√°gina
            yPosition = pageHeight - 15;
            doc.setFontSize(8);
            doc.setTextColor(128, 128, 128);
            doc.text('Generado por: Calculadora de Compras', pageWidth / 2, yPosition, { align: 'center' });
            doc.text('Este comprobante puede ser compartido en cualquier plataforma', pageWidth / 2, yPosition + 5, { align: 'center' });
            
            // Descargar PDF
            const fecha_descarga = new Date().toISOString().split('T')[0];
            doc.save(`lista-compras-${fecha_descarga}.pdf`);
        }
        
        // Funci√≥n para compartir PDF (usando Web Share API si est√° disponible)
        function compartirResumen() {
            const titulo = document.getElementById('resumenTitulo').textContent;
            const fecha = document.getElementById('resumenFecha').textContent;
            
            // Crear el PDF en memoria
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            // Colores
            const colorPrimario = '#39ff14';
            const colorTexto = '#000000';
            
            let yPosition = 20;
            const pageHeight = doc.internal.pageSize.height;
            const pageWidth = doc.internal.pageSize.width;
            const margen = 15;
            const anchoUtil = pageWidth - (2 * margen);
            
            // T√≠tulo
            doc.setFontSize(18);
            doc.setTextColor(0, 0, 0); // Negro
            doc.text(titulo, pageWidth / 2, yPosition, { align: 'center' });
            
            // Fecha
            yPosition += 10;
            doc.setFontSize(10);
            doc.setTextColor(128, 128, 128);
            doc.text(fecha, pageWidth / 2, yPosition, { align: 'center' });
            
            // L√≠nea divisoria
            yPosition += 8;
            doc.setDrawColor(57, 255, 20);
            doc.line(margen, yPosition, pageWidth - margen, yPosition);
            
            // T√≠tulos de columnas
            yPosition += 10;
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'bold');
            
            const colAncho = anchoUtil / 3;
            doc.text('Producto', margen + 5, yPosition);
            doc.text('Cantidad', pageWidth - margen - 30, yPosition, { align: 'right' });
            doc.text('Precio', pageWidth - margen - 5, yPosition, { align: 'right' });
            
            // L√≠nea bajo encabezado
            yPosition += 2;
            doc.setDrawColor(200, 200, 200);
            doc.line(margen, yPosition, pageWidth - margen, yPosition);
            
            // Agregar √≠tems
            yPosition += 8;
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            
            const itemsContainer = document.querySelector('#resumenItems');
            const items = itemsContainer.querySelectorAll('.resumen-item');
            
            items.forEach((item) => {
                if (yPosition > pageHeight - 50) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                const nombre = item.querySelector('.resumen-item-name')?.textContent || 'Sin nombre';
                const cantidad = item.querySelector('.resumen-item-details')?.textContent || '';
                const precio = item.querySelector('.resumen-item-price')?.textContent || '$0';
                
                doc.setFont(undefined, 'bold');
                doc.text(nombre.substring(0, 30), margen + 5, yPosition);
                
                doc.setFont(undefined, 'normal');
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.text(cantidad, pageWidth - margen - 30, yPosition + 3, { align: 'right' });
                doc.text(precio, pageWidth - margen - 5, yPosition + 3, { align: 'right' });
                
                yPosition += 7;
                doc.setFontSize(9);
                doc.setTextColor(0, 0, 0);
            });
            
            // L√≠nea divisoria antes de resumen
            yPosition += 5;
            doc.setDrawColor(200, 200, 200);
            doc.line(margen, yPosition, pageWidth - margen, yPosition);
            
            // Resumen
            yPosition += 8;
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            
            const summaryContainer = document.querySelector('#resumenSummary');
            const rows = summaryContainer.querySelectorAll('.resumen-summary-row');
            
            rows.forEach((row) => {
                const isTotal = row.classList.contains('total');
                const cells = row.querySelectorAll('span');
                const label = cells[0]?.textContent || '';
                const value = cells[1]?.textContent || '';
                
                if (isTotal) {
                    doc.setFont(undefined, 'bold');
                    doc.setFontSize(12);
                    doc.setTextColor(57, 255, 20); // Verde caracter√≠stico
                    doc.setFillColor(0, 0, 0); // Fondo negro
                    doc.rect(margen, yPosition - 5, anchoUtil, 8, 'F');
                } else {
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(10);
                    doc.setTextColor(0, 0, 0);
                }
                
                doc.text(label, margen + 5, yPosition);
                doc.text(value, pageWidth - margen - 5, yPosition, { align: 'right' });
                yPosition += 7;
            });
            
            // Pie de p√°gina
            yPosition = pageHeight - 15;
            doc.setFontSize(8);
            doc.setTextColor(128, 128, 128);
            doc.text('Generado por: Calculadora de Compras', pageWidth / 2, yPosition, { align: 'center' });
            doc.text('Este comprobante puede ser compartido en cualquier plataforma', pageWidth / 2, yPosition + 5, { align: 'center' });
            
            // Convertir a blob y compartir
            const blob = doc.output('blob');
            const fecha_descarga = new Date().toISOString().split('T')[0];
            const fileName = `lista-compras-${fecha_descarga}.pdf`;
            
            // Usar Web Share API si est√° disponible
            if (navigator.share) {
                const file = new File([blob], fileName, { type: 'application/pdf' });
                navigator.share({
                    title: 'Mi lista de compras',
                    text: `Compartiendo mi lista de compras del ${fecha_descarga}`,
                    files: [file]
                }).catch(err => console.log('Error al compartir:', err));
            } else {
                // Fallback: descargar si Web Share API no est√° disponible
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = fileName;
                link.click();
                URL.revokeObjectURL(link.href);
            }
        }

        // Gr√°ficos
        // Variables para gr√°ficos
        let chartInstances = {};
        
        function cambiarTabGastos(tabId) {
            // Actualizar tabs
            document.querySelectorAll('.gastos-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            
            // Destruir todos los gr√°ficos antes de cambiar de tab
            ['chartTopArticulos', 'chartCategorias', 'chartDescuentos', 'chartComparacion', 'chartPresupuesto'].forEach(chartId => {
                destruirGrafico(chartId);
            });
            
            // Actualizar paneles
            document.querySelectorAll('.gastos-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            document.getElementById(`panel-${tabId}`).classList.add('active');
            
            // Renderizar gr√°fico del tab activo
            renderizarTabActivo(tabId);
        }
        
        function renderizarTabActivo(tabId) {
            switch(tabId) {
                case 'top-articulos':
                    renderizarTopArticulos();
                    break;
                case 'por-categoria':
                    renderizarPorCategoria();
                    break;
                case 'descuentos':
                    renderizarDescuentos();
                    break;
                case 'comparacion':
                    renderizarComparacion();
                    break;
                case 'presupuesto':
                    renderizarPresupuesto();
                    break;
                case 'iva':
                    renderizarIVA();
                    break;
            }
        }
        
        function renderizarGraficos() {
            // Renderizar el tab activo por defecto (top-articulos)
            renderizarTopArticulos();
        }
        
        function destruirGrafico(id) {
            if (chartInstances[id]) {
                chartInstances[id].destroy();
                delete chartInstances[id];
            }
        }
        
        // Helper para obtener colores seg√∫n el tema actual
        function getChartColors() {
            const isDark = document.documentElement.getAttribute('data-theme') !== 'light';
            return {
                textColor: isDark ? '#ffffff' : '#1a1a1a',
                gridColor: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(26, 26, 26, 0.1)'
            };
        }
        
        // 1. Top 5 Art√≠culos
        function renderizarTopArticulos() {
            destruirGrafico('chartTopArticulos');
            const colors = getChartColors();
            
            if (productos.length === 0) {
                document.getElementById('statsTopArticulos').innerHTML = '<div class="empty-state-text">No hay productos para mostrar</div>';
                return;
            }
            
            // Calcular top 5 por gasto total
            const productosOrdenados = [...productos].sort((a, b) => b.total - a.total).slice(0, 5);
            
            const ctx = document.getElementById('chartTopArticulos').getContext('2d');
            chartInstances['chartTopArticulos'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: productosOrdenados.map(p => p.nombre),
                    datasets: [{
                        label: 'Gasto Total',
                        data: productosOrdenados.map(p => p.total),
                        backgroundColor: '#39ff14',
                        borderRadius: 8
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            ticks: { color: colors.textColor },
                            grid: { color: colors.gridColor }
                        },
                        y: {
                            ticks: { color: colors.textColor },
                            grid: { display: false }
                        }
                    }
                }
            });
            
            // Stats adicionales
            const totalGasto = productos.reduce((sum, p) => sum + p.total, 0);
            const statsHTML = productosOrdenados.map((p, i) => `
                <div class="stat-row">
                    <span class="stat-row-label">${i + 1}. ${p.nombre}</span>
                    <span class="stat-row-value">${formatearPrecio(p.total)} (${((p.total / totalGasto) * 100).toFixed(1)}%)</span>
                </div>
            `).join('');
            document.getElementById('statsTopArticulos').innerHTML = statsHTML;
        }
        
        // 2. Gastos por Categor√≠a
        function renderizarPorCategoria() {
            destruirGrafico('chartCategorias');
            const colors = getChartColors();
            
            if (productos.length === 0) {
                document.getElementById('statsCategorias').innerHTML = '<div class="empty-state-text">No hay productos para mostrar</div>';
                return;
            }
            
            const categorias = {};
            productos.forEach(p => {
                const cat = p.categoria || 'sin-categoria';
                categorias[cat] = (categorias[cat] || 0) + p.total;
            });
            
            const ctx = document.getElementById('chartCategorias').getContext('2d');
            chartInstances['chartCategorias'] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categorias).map(c => getCategoriaTexto(c)),
                    datasets: [{
                        data: Object.values(categorias),
                        backgroundColor: ['#39ff14', '#00d4ff', '#ff0080', '#ffcc00', '#ff6b35', '#a855f7', '#10b981']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: colors.textColor, padding: 15 }
                        }
                    }
                }
            });
            
            // Stats
            const totalGasto = Object.values(categorias).reduce((a, b) => a + b, 0);
            const statsHTML = Object.entries(categorias)
                .sort((a, b) => b[1] - a[1])
                .map(([cat, total]) => `
                    <div class="stat-row">
                        <span class="stat-row-label">${getCategoriaTexto(cat)}</span>
                        <span class="stat-row-value">${formatearPrecio(total)} (${((total / totalGasto) * 100).toFixed(1)}%)</span>
                    </div>
                `).join('');
            document.getElementById('statsCategorias').innerHTML = statsHTML;
        }
        
        // 3. Impacto de Descuentos
        function renderizarDescuentos() {
            destruirGrafico('chartDescuentos');
            const colors = getChartColors();
            
            const productosConPromo = productos.filter(p => p.tienePromo && p.tipoPromo === 'descuento');
            const totalAhorrado = productosConPromo.reduce((sum, p) => {
                const precioOriginal = p.total / (1 - p.valorDescuento / 100);
                return sum + (precioOriginal - p.total);
            }, 0);
            
            const promedioDescuento = productosConPromo.length > 0
                ? productosConPromo.reduce((sum, p) => sum + p.valorDescuento, 0) / productosConPromo.length
                : 0;
            
            document.getElementById('totalAhorrado').textContent = formatearPrecio(totalAhorrado);
            document.getElementById('productosConDescuento').textContent = productosConPromo.length;
            document.getElementById('porcentajeAhorro').textContent = promedioDescuento.toFixed(1) + '%';
            
            if (productosConPromo.length === 0) {
                const chartContainer = document.getElementById('chartDescuentos');
                if (chartContainer && chartContainer.parentElement) {
                    chartContainer.parentElement.innerHTML = '<div class="empty-state-text">No hay productos con descuento</div>';
                }
                return;
            }
            
            // Gr√°fico de barras con descuentos
            const ctx = document.getElementById('chartDescuentos');
            if (!ctx) return;
            
            chartInstances['chartDescuentos'] = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: productosConPromo.map(p => p.nombre),
                    datasets: [{
                        label: '% Descuento',
                        data: productosConPromo.map(p => p.valorDescuento),
                        backgroundColor: '#00d4ff',
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { color: colors.textColor, callback: (value) => value + '%' },
                            grid: { color: colors.gridColor }
                        },
                        x: {
                            ticks: { color: colors.textColor },
                            grid: { display: false }
                        }
                    }
                }
            });
        }
        
        // 4. Comparaci√≥n con Listas Anteriores
        function renderizarComparacion() {
            destruirGrafico('chartComparacion');
            const colors = getChartColors();
            
            const listas = JSON.parse(localStorage.getItem('listasGuardadas') || '{}');
            const listasArray = Object.entries(listas)
                .map(([id, lista]) => ({
                    fecha: new Date(lista.fecha),
                    total: lista.total,
                    nombre: lista.nombre
                }))
                .sort((a, b) => a.fecha - b.fecha)
                .slice(-2); // √öltimas 2 listas (actual y pen√∫ltima)
            
            if (listasArray.length === 0) {
                document.getElementById('statsComparacion').innerHTML = '<div class="empty-state-text">No hay listas guardadas para comparar</div>';
                return;
            }
            
            const ctx = document.getElementById('chartComparacion').getContext('2d');
            chartInstances['chartComparacion'] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: listasArray.map(l => l.fecha.toLocaleDateString('es', { month: 'short', day: 'numeric' })),
                    datasets: [{
                        label: 'Gasto Total',
                        data: listasArray.map(l => l.total),
                        borderColor: '#39ff14',
                        backgroundColor: 'rgba(57, 255, 20, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { labels: { color: colors.textColor } }
                    },
                    scales: {
                        y: {
                            ticks: { color: colors.textColor },
                            grid: { color: colors.gridColor }
                        },
                        x: {
                            ticks: { color: colors.textColor },
                            grid: { color: colors.gridColor }
                        }
                    }
                }
            });
            
            // Stats
            const promedio = listasArray.reduce((sum, l) => sum + l.total, 0) / listasArray.length;
            const maximo = Math.max(...listasArray.map(l => l.total));
            const minimo = Math.min(...listasArray.map(l => l.total));
            
            document.getElementById('statsComparacion').innerHTML = `
                <div class="stat-row">
                    <span class="stat-row-label">Promedio</span>
                    <span class="stat-row-value">${formatearPrecio(promedio)}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-row-label">M√°ximo</span>
                    <span class="stat-row-value">${formatearPrecio(maximo)}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-row-label">M√≠nimo</span>
                    <span class="stat-row-value">${formatearPrecio(minimo)}</span>
                </div>
            `;
        }
        
        // 5. Presupuesto vs Real
        function renderizarPresupuesto() {
            // Crear din√°micamente los contenedores si no existen
            const panelPresupuesto = document.getElementById('panel-presupuesto');
            let chartContainer = document.getElementById('chartPresupuesto')?.parentElement;
            let presupuestoAnalisisDiv = document.getElementById('presupuestoAnalisis');
            
            if (!chartContainer) {
                chartContainer = document.createElement('div');
                chartContainer.className = 'chart-container';
                const canvas = document.createElement('canvas');
                canvas.id = 'chartPresupuesto';
                chartContainer.appendChild(canvas);
                panelPresupuesto.appendChild(chartContainer);
            }
            
            if (!presupuestoAnalisisDiv) {
                presupuestoAnalisisDiv = document.createElement('div');
                presupuestoAnalisisDiv.id = 'presupuestoAnalisis';
                panelPresupuesto.appendChild(presupuestoAnalisisDiv);
            }
            
            destruirGrafico('chartPresupuesto');
            
            const totalActual = productos.reduce((sum, p) => sum + p.total, 0);
            const diferencia = presupuesto - totalActual;
            const porcentajeUsado = presupuesto > 0 ? (totalActual / presupuesto) * 100 : 0;
            
            document.getElementById('presupuestoPlaneado').textContent = formatearPrecio(presupuesto);
            document.getElementById('gastoReal').textContent = formatearPrecio(totalActual);
            document.getElementById('diferencia').textContent = formatearPrecio(Math.abs(diferencia));
            
            // Aplicar color seg√∫n tema
            const tema = document.documentElement.getAttribute('data-theme');
            if (tema === 'light') {
                document.getElementById('diferencia').style.color = '#000000';
            } else {
                document.getElementById('diferencia').style.color = diferencia >= 0 ? '#39ff14' : '#ff0080';
            }
            
            if (presupuesto === 0) {
                document.getElementById('presupuestoAnalisis').innerHTML = '<div class="empty-state-text">No has establecido un presupuesto</div>';
                return;
            }
            
            // Gr√°fico de gauge
            const ctx = document.getElementById('chartPresupuesto').getContext('2d');
            chartInstances['chartPresupuesto'] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Usado', 'Disponible'],
                    datasets: [{
                        data: [totalActual, Math.max(0, diferencia)],
                        backgroundColor: [
                            porcentajeUsado > 100 ? '#ff0080' : porcentajeUsado > 80 ? '#ffcc00' : '#39ff14',
                            'rgba(150, 150, 150, 0.4)'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    circumference: 180,
                    rotation: -90,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    return context.label + ': ' + formatearPrecio(context.parsed);
                                }
                            }
                        }
                    }
                }
            });
            
            // An√°lisis
            let analisisHTML = '';
            if (porcentajeUsado <= 80) {
                analisisHTML = `
                    <div class="analisis-row">
                        <div class="analisis-icon">‚úÖ</div>
                        <div class="analisis-text">
                            <div class="analisis-title">¬°Excelente control!</div>
                            <div class="analisis-description">Has usado el ${porcentajeUsado.toFixed(1)}% de tu presupuesto. Te quedan ${formatearPrecio(diferencia)} disponibles.</div>
                        </div>
                    </div>
                `;
            } else if (porcentajeUsado <= 100) {
                analisisHTML = `
                    <div class="analisis-row">
                        <div class="analisis-icon">‚ö†Ô∏è</div>
                        <div class="analisis-text">
                            <div class="analisis-title">Cerca del l√≠mite</div>
                            <div class="analisis-description">Has usado el ${porcentajeUsado.toFixed(1)}% de tu presupuesto. Solo te quedan ${formatearPrecio(diferencia)}.</div>
                        </div>
                    </div>
                `;
            } else {
                analisisHTML = `
                    <div class="analisis-row">
                        <div class="analisis-icon">üö®</div>
                        <div class="analisis-text">
                            <div class="analisis-title">Presupuesto excedido</div>
                            <div class="analisis-description">Has gastado ${formatearPrecio(Math.abs(diferencia))} m√°s de lo planeado (${porcentajeUsado.toFixed(1)}%).</div>
                        </div>
                    </div>
                `;
            }
            document.getElementById('presupuestoAnalisis').innerHTML = analisisHTML;
        }


        // Funciones para manejo de IVA
        function agregarIVATotal() {
            const inputIVA = document.getElementById('inputIVATotal');
            const valorIVA = parseFloat(inputIVA.value.replace(/\./g, '').replace(/,/g, '.')) || 0;
            
            if (valorIVA <= 0) {
                return;
            }
            
            // Obtener historial de IVA
            let historialIVA = JSON.parse(localStorage.getItem('historialIVA') || '[]');
            
            // Obtener √∫ltima lista guardada
            const listas = JSON.parse(localStorage.getItem('listasGuardadas') || '{}');
            const listaActual = Object.keys(listas).length > 0 ? 
                Object.values(listas)[Object.keys(listas).length - 1] : null;
            
            const nombreLista = listaActual ? listaActual.nombre : 'Compra sin lista';
            const totalProductos = productos.reduce((sum, p) => sum + p.total, 0);
            
            // Agregar nuevo registro
            const nuevoRegistro = {
                id: Date.now(),
                fecha: new Date().toISOString(),
                nombreLista: nombreLista,
                ivaTotal: valorIVA,
                totalProductos: totalProductos,
                totalConIVA: totalProductos + valorIVA
            };
            
            historialIVA.push(nuevoRegistro);
            localStorage.setItem('historialIVA', JSON.stringify(historialIVA));
            
            inputIVA.value = '';
            actualizarInfoIVAPresupuesto();
            renderizarIVA();
        }
        
        function actualizarInfoIVAPresupuesto() {
            const historialIVA = JSON.parse(localStorage.getItem('historialIVA') || '[]');
            const ultimoRegistro = historialIVA.length > 0 ? historialIVA[historialIVA.length - 1] : null;
            
            const infoDiv = document.getElementById('ivaAgregadoInfo');
            const valorDiv = document.getElementById('ivaAgregadoValor');
            
            // Solo actualizar si los elementos existen
            if (infoDiv && valorDiv) {
                if (ultimoRegistro) {
                    infoDiv.style.display = 'block';
                    valorDiv.textContent = formatearPrecio(ultimoRegistro.ivaTotal);
                } else {
                    infoDiv.style.display = 'none';
                }
            }
        }
        
        function renderizarIVA() {
            const historialIVA = JSON.parse(localStorage.getItem('historialIVA') || '[]');
            
            // Calcular estad√≠sticas (con TODOS los registros)
            const totalIVA = historialIVA.reduce((sum, reg) => sum + reg.ivaTotal, 0);
            const numeroCompras = historialIVA.length;
            const promedioIVA = numeroCompras > 0 ? totalIVA / numeroCompras : 0;
            
            // Actualizar tarjetas con datos totales
            document.getElementById('totalIVAPagado').textContent = formatearPrecio(totalIVA);
            document.getElementById('numeroComprasIVA').textContent = numeroCompras.toString();
            document.getElementById('promedioIVA').textContent = formatearPrecio(promedioIVA);
            
            // Renderizar lista de compras - SOLO √öLTIMOS 10 REGISTROS
            const listaDiv = document.getElementById('listaIVACompras');
            
            if (historialIVA.length === 0) {
                listaDiv.innerHTML = `
                    <p style="font-size: 12px; color: var(--text-muted); text-align: center; padding: 20px;">
                        No hay registros de IVA a√∫n
                    </p>
                `;
                return;
            }
            
            // Mostrar en orden inverso (m√°s recientes primero) - SOLO √öLTIMOS 5
            const registrosOrdenados = [...historialIVA].reverse().slice(0, 5);
            
            // Mostrar informaci√≥n sobre cu√°ntos registros se est√°n viendo
            const totalRegistros = historialIVA.length;
            const avisoRegistros = totalRegistros > 5 ? `<p style="font-size: 11px; color: var(--text-muted); text-align: center; padding: 8px; background: rgba(57, 255, 20, 0.05); border-radius: 6px; margin-bottom: 12px;">Mostrando √∫ltimos 5 de ${totalRegistros} registros</p>` : '';
            
            listaDiv.innerHTML = avisoRegistros + registrosOrdenados.map(reg => {
                const fecha = new Date(reg.fecha).toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                return `
                    <div style="padding: 12px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <p style="font-size: 13px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">
                                ${reg.nombreLista}
                            </p>
                            <p style="font-size: 11px; color: var(--text-muted); margin-bottom: 6px;">
                                ${fecha}
                            </p>
                            <p style="font-size: 11px; color: var(--text-muted);">
                                Subtotal: ${formatearPrecio(reg.totalProductos)}
                            </p>
                        </div>
                        <div style="text-align: right;">
                            <p style="font-size: 13px; font-weight: 700; margin-bottom: 4px;" class="iva-indicator">
                                IVA: ${formatearPrecio(reg.ivaTotal)}
                            </p>
                            <p style="font-size: 11px; color: var(--text-muted);">
                                Total: ${formatearPrecio(reg.totalConIVA)}
                            </p>
                        </div>
                    </div>
                `;
            }).join('');
        }
        

        // Configuraci√≥n
        function cambiarIdioma() {
            idioma = document.getElementById('selectIdioma').value;
            localStorage.setItem('idioma', idioma);
            aplicarTraducciones();
        }

        function aplicarTraducciones() {
            const trad = traducciones[idioma];
            
            // Traducir botones Guardar y Limpiar
            document.querySelectorAll('.action-buttons-top .btn').forEach((btn, index) => {
                if (index === 0) btn.innerHTML = `<ion-icon name="save" style="margin-right: 4px;"></ion-icon>${trad.guardarLista}`;
                else if (index === 1) btn.innerHTML = `<ion-icon name="trash" style="margin-right: 4px;"></ion-icon>${trad.limpiarTodo}`;
            });
            
            // Traducir bot√≥n agregar art√≠culo
            const btnAgregar = document.querySelector('.btn-add-item');
            if (btnAgregar) btnAgregar.innerHTML = `<ion-icon name="add" style="margin-right: 8px;"></ion-icon>${trad.agregarArticulo}`;
            
            // Traducir t√≠tulos de botones editar y eliminar
            document.querySelectorAll('.item-btn-icon').forEach((btn, index) => {
                const mod = index % 3;
                if (mod === 0) btn.setAttribute('title', trad.editar);
                else if (mod === 1) btn.setAttribute('title', trad.eliminar);
            });
            
            // Re-renderizar productos
            renderizarProductos();
            actualizarTotales();
        }

        // Utilidades
        // Formatear precio con o sin decimales
        function formatearPrecio(valor) {
            if (mostrarDecimales) {
                return '$' + valor.toLocaleString('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            } else {
                return '$' + Math.round(valor).toLocaleString('es-CO');
            }
        }

        function formatearNumero(numero) {
            return new Intl.NumberFormat('es-CO', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 2
            }).format(numero);
        }

        function limpiarNumero(texto) {
            return parseFloat(texto.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
        }

        function mostrarConfirm(titulo, texto, callback, cancelCallback, textoBtnSi = 'Seguro', textoBtnNo = 'Cancelar') {
            document.getElementById('confirmTitle').textContent = titulo;
            document.getElementById('confirmText').textContent = texto;
            document.getElementById('confirmDialogOverlay').classList.add('active');
            document.getElementById('confirmDialog').classList.add('active');
            document.getElementById('sidebarOverlay').classList.add('blocked');
            document.body.classList.add('no-scroll');
            
            const confirmBtn = document.getElementById('confirmButton');
            const confirmBtnSecond = document.getElementById('confirmButtonSecond');
            
            // Si hay un segundo callback, mostrar dos botones verticales
            if (cancelCallback && typeof cancelCallback === 'function') {
                // Modo dos botones vertical
                confirmBtn.style.display = 'inline-block';
                confirmBtnSecond.style.display = 'inline-block';
                
                confirmBtn.innerHTML = textoBtnSi;
                confirmBtnSecond.innerHTML = textoBtnNo;
                
                confirmBtn.onclick = () => {
                    callback();
                    cerrarConfirm();
                };
                
                confirmBtnSecond.onclick = () => {
                    cancelCallback();
                    cerrarConfirm();
                };
            } else {
                // Modo un bot√≥n (compatible con versiones anteriores)
                confirmBtn.style.display = 'inline-block';
                confirmBtnSecond.style.display = 'none';
                
                confirmBtn.textContent = textoBtnSi;
                
                confirmBtn.onclick = () => {
                    callback();
                    cerrarConfirm();
                };
            }
        }

        function cerrarConfirm() {
            document.getElementById('confirmDialogOverlay').classList.remove('active');
            document.getElementById('confirmDialog').classList.remove('active');
            document.getElementById('sidebarOverlay').classList.remove('blocked');
            document.body.classList.remove('no-scroll');
        }
        
        // Funci√≥n para mostrar alertas en modal
        function mostrarAlertaModal(titulo, mensaje, callback, textoBot√≥n = 'Aceptar') {
            document.getElementById('confirmTitle').innerHTML = titulo;
            document.getElementById('confirmText').textContent = mensaje;
            document.getElementById('confirmDialogOverlay').classList.add('active');
            document.getElementById('confirmDialog').classList.add('active');
            document.getElementById('sidebarOverlay').classList.add('blocked');
            document.body.classList.add('no-scroll');
            
            const confirmBtn = document.getElementById('confirmButton');
            const confirmBtnSecond = document.getElementById('confirmButtonSecond');
            
            // Para alertas, mostramos solo el bot√≥n de aceptar
            confirmBtn.style.display = 'inline-block';
            confirmBtnSecond.style.display = 'none';
            confirmBtn.innerHTML = textoBot√≥n;
            
            confirmBtn.onclick = () => {
                if (callback) {
                    callback();
                }
                cerrarConfirm();
            };
        }

        // LocalStorage
        function guardarProductos() {
            localStorage.setItem('productos', JSON.stringify(productos));
        }

        function cargarProductos() {
            productos = JSON.parse(localStorage.getItem('productos') || '[]');
        }

        function cargarConfiguracion() {
            idioma = localStorage.getItem('idioma') || 'es';
            presupuesto = parseFloat(localStorage.getItem('presupuesto')) || 0;
            temaActual = localStorage.getItem('tema') || 'dark';
            
            // Cargar configuraci√≥n de campos visibles
            const camposGuardados = localStorage.getItem('mostrarCampos');
            if (camposGuardados) {
                mostrarCampos = JSON.parse(camposGuardados);
            }
            
            // Cargar configuraci√≥n de decimales
            mostrarDecimales = localStorage.getItem('mostrarDecimales') === 'true';
            
            document.getElementById('selectIdioma').value = idioma;
            document.documentElement.setAttribute('data-theme', temaActual);
            
            // Inicializar variables temporales
            mostrarCamposTemp = {...mostrarCampos};
            mostrarDecimalesTemp = mostrarDecimales;
            idiomaTemp = idioma;
            
            // Actualizar checkboxes de configuraci√≥n si existen
            setTimeout(() => {
                if (document.getElementById('checkMarca')) {
                    document.getElementById('checkMarca').checked = mostrarCampos.marca;
                    document.getElementById('checkCategoria').checked = mostrarCampos.categoria;
                    document.getElementById('checkNota').checked = mostrarCampos.nota;
                    document.getElementById('checkPromociones').checked = mostrarCampos.promociones;
                    document.getElementById('checkDecimales').checked = mostrarDecimales;
                }
            }, 100);
        }
        
        function guardarConfiguracionCampos() {
            localStorage.setItem('mostrarCampos', JSON.stringify(mostrarCampos));
            localStorage.setItem('mostrarDecimales', mostrarDecimales.toString());
            aplicarVisibilidadCampos();
            renderizarProductos();
            actualizarTotales();
        }
        
        function aplicarVisibilidadCampos() {
            // En el modal de art√≠culo
            const campoMarca = document.getElementById('campoMarca');
            const campoCategoria = document.getElementById('campoCategoria');
            const campoNota = document.getElementById('campoNota');
            const campoPromociones = document.getElementById('campoPromociones');
            
            if (campoMarca) campoMarca.style.display = mostrarCampos.marca ? 'block' : 'none';
            if (campoCategoria) campoCategoria.style.display = mostrarCampos.categoria ? 'block' : 'none';
            if (campoNota) campoNota.style.display = mostrarCampos.nota ? 'block' : 'none';
            if (campoPromociones) campoPromociones.style.display = mostrarCampos.promociones ? 'block' : 'none';
        }
        
        function toggleCampo(campo) {
            mostrarCamposTemp[campo] = !mostrarCamposTemp[campo];
            document.getElementById('check' + campo.charAt(0).toUpperCase() + campo.slice(1)).checked = mostrarCamposTemp[campo];
            mostrarBotonAplicarCambios();
        }
        
        function toggleDecimales() {
            mostrarDecimalesTemp = !mostrarDecimalesTemp;
            document.getElementById('checkDecimales').checked = mostrarDecimalesTemp;
            mostrarBotonAplicarCambios();
        }
        
        function cambiarIdiomaTemp() {
            idiomaTemp = document.getElementById('selectIdioma').value;
            mostrarBotonAplicarCambios();
        }
        
        function mostrarBotonAplicarCambios() {
            // Mostrar bot√≥n de aplicar cambios si no existe
            let btnAplicar = document.getElementById('btnAplicarCambios');
            if (!btnAplicar) {
                const configContainer = document.getElementById('seccionConfiguracion');
                btnAplicar = document.createElement('div');
                btnAplicar.id = 'btnAplicarCambios';
                btnAplicar.className = 'btn-aplicar-container';
                btnAplicar.innerHTML = `
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="confirmarAplicarCambios()">
                            Aplicar Cambios
                        </button>
                        <button class="btn btn-secondary" onclick="cancelarCambios()">
                            Cancelar
                        </button>
                    </div>
                `;
                configContainer.appendChild(btnAplicar);
            }
            btnAplicar.style.display = 'block';
        }
        
        function confirmarAplicarCambios() {
            mostrarConfirm(
                '¬øAplicar cambios?',
                '¬øEst√°s seguro de que deseas aplicar estos cambios en la configuraci√≥n?',
                () => {
                    // Aplicar cambios
                    mostrarCampos = {...mostrarCamposTemp};
                    mostrarDecimales = mostrarDecimalesTemp;
                    idioma = idiomaTemp;
                    
                    // Guardar en localStorage
                    guardarConfiguracionCampos();
                    localStorage.setItem('idioma', idioma);
                    
                    // Aplicar traducciones si cambi√≥ el idioma
                    aplicarTraducciones();
                    
                    // Ocultar bot√≥n
                    const btnAplicar = document.getElementById('btnAplicarCambios');
                    if (btnAplicar) btnAplicar.style.display = 'none';
                    
                    mostrarAlertaModal('‚úÖ Cambios guardados', 'Cambios aplicados exitosamente');
                },
                () => {
                    // Cancelar - restaurar valores
                    mostrarCamposTemp = {...mostrarCampos};
                    mostrarDecimalesTemp = mostrarDecimales;
                    idiomaTemp = idioma;
                    
                    // Restaurar checkboxes
                    document.getElementById('checkMarca').checked = mostrarCampos.marca;
                    document.getElementById('checkCategoria').checked = mostrarCampos.categoria;
                    document.getElementById('checkNota').checked = mostrarCampos.nota;
                    document.getElementById('checkPromociones').checked = mostrarCampos.promociones;
                    document.getElementById('checkDecimales').checked = mostrarDecimales;
                    document.getElementById('selectIdioma').value = idioma;
                    
                    // Ocultar bot√≥n
                    const btnAplicar = document.getElementById('btnAplicarCambios');
                    if (btnAplicar) btnAplicar.style.display = 'none';
                }
            );
        }
        
        function cancelarCambios() {
            // Restaurar valores
            mostrarCamposTemp = {...mostrarCampos};
            mostrarDecimalesTemp = mostrarDecimales;
            idiomaTemp = idioma;
            
            // Restaurar checkboxes
            document.getElementById('checkMarca').checked = mostrarCampos.marca;
            document.getElementById('checkCategoria').checked = mostrarCampos.categoria;
            document.getElementById('checkNota').checked = mostrarCampos.nota;
            document.getElementById('checkPromociones').checked = mostrarCampos.promociones;
            document.getElementById('checkDecimales').checked = mostrarDecimales;
            document.getElementById('selectIdioma').value = idioma;
            
            // Ocultar bot√≥n
            const btnAplicar = document.getElementById('btnAplicarCambios');
            if (btnAplicar) btnAplicar.style.display = 'none';
        }

        // Formateo de precio
        document.getElementById('precioProducto').addEventListener('input', function(e) {
            let valor = e.target.value.replace(/[^\d,]/g, '');
            if (valor) {
                const partes = valor.split(',');
                partes[0] = partes[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                e.target.value = partes.join(',');
            }
        });
        
        // Formateo de presupuesto
        document.getElementById('inputPresupuesto').addEventListener('input', function(e) {
            let valor = e.target.value.replace(/[^\d,]/g, '');
            if (valor) {
                const partes = valor.split(',');
                partes[0] = partes[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                e.target.value = partes.join(',');
            }
        });

        // Formateo de IVA en modal
        document.getElementById('inputIVAModalTotal').addEventListener('input', function(e) {
            let valor = e.target.value.replace(/[^\d,]/g, '');
            if (valor) {
                const partes = valor.split(',');
                partes[0] = partes[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                e.target.value = partes.join(',');
            }
        });

        // Bloquear interacciones fuera del modal - NO permitir cerrar con ESC
        // Los modales solo se cierran con botones expl√≠citos (X, Cancelar, etc.)
        
        // Funci√≥n para verificar si hay un modal activo
        function hayModalActivo() {
            const modales = [
                'modalArticulo',
                'modalGuardar', 
                'modalPresupuesto',
                'modalGuardarPresupuesto',
                'modalAgregarIVA',
                'modalConfirmacionPagoIVA',
                'modalResumen',
                'confirmDialog'
            ];
            
            return modales.some(id => {
                const elem = document.getElementById(id);
                return elem && elem.classList.contains('active');
            });
        }
        
        // Bloquear teclas cuando hay modal activo
        document.addEventListener('keydown', function(e) {
            if (!hayModalActivo()) return;
            
            // Prevenir ESC
            if (e.key === 'Escape') {
                e.preventDefault();
                return false;
            }
        }, true); // Usar capture phase para prevenir bubbling
        
        // Bloquear clics en elementos fuera del modal (pero permitir botones)
        document.addEventListener('click', function(e) {
            if (!hayModalActivo()) return;
            
            // No bloquear clics en elementos interactivos
            if (e.target.closest('button, input, textarea, select, a, [role="button"]')) {
                return;
            }
            
            // Encontrar el modal activo
            const modales = [
                { id: 'modalArticulo', selector: '.modal-content' },
                { id: 'modalGuardar', selector: '.modal-content' },
                { id: 'modalPresupuesto', selector: '.modal-content' },
                { id: 'modalGuardarPresupuesto', selector: '.modal-content' },
                { id: 'modalAgregarIVA', selector: '.modal-content' },
                { id: 'modalConfirmacionPagoIVA', selector: '.modal-content' },
                { id: 'modalResumen', selector: '.resumen-container' },
                { id: 'confirmDialog', selector: '.confirm-dialog' }
            ];
            
            const modalActivo = modales.find(m => {
                const elem = document.getElementById(m.id);
                return elem && elem.classList.contains('active');
            });
            
            if (modalActivo) {
                const contenido = document.querySelector(`#${modalActivo.id} ${modalActivo.selector}`);
                if (contenido && !contenido.contains(e.target)) {
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                }
            }
        }, true); // Usar capture phase
        
        // Bloquear scroll cuando hay modal activo
        document.addEventListener('wheel', function(e) {
            if (hayModalActivo() && !e.target.closest('.modal-content, .resumen-container, .confirm-dialog')) {
                e.preventDefault();
            }
        }, { passive: false });
        
        document.addEventListener('touchmove', function(e) {
            if (hayModalActivo() && !e.target.closest('.modal-content, .resumen-container, .confirm-dialog')) {
                e.preventDefault();
            }
        }, { passive: false });

        // Inicializar app
        window.onload = init;
        
        // Asegurar que Ionicons se renderice correctamente
        document.addEventListener('DOMContentLoaded', () => {
            // Forzar renderizado de los iconos
            if (window.ionicons) {
                window.ionicons.render();
            }
        });
    </script>
</body>
</html>